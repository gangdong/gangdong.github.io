---
layout: post
title:  "Fingerprint driver development in Windows(2)"
date:   2020-06-10 20:57:55 +0800
categories: C++ Fingerprint Windows
tags: C++ Fingerprint Windows
Published: true
---
Continue...

## <span id = "3">3. Biometric Unit</span>  
Biometric devices are manufactured in a wide variety of types and configurations. The Windows Biometric Framework (WBF) addresses this variety by providing an extensible architecture that enables third-party developers to create custom plug-in components. A primary component is a software object called a **biometric unit**. Biometric units expose the capabilities of a device to the framework through a standard interface that consists of **sensor**, **engine**, and **storage** adapters

A single physical sensor is associated with each biometric unit. The sensor captures biometric data and may also, depending on its hardware capabilities, perform other biometric operations such as template matching and storage. Sensors that do not support onboard matching or storage require additional software modules to perform these functions.     

![framework]({{site.cdn_baseurl}}/assets/image/others-wbdi2-01.PNG){: .center-image }  

The above diagram shows how data flows through a biometric unit. Essentially, the data flow forms a type of pipeline. The initial input to the pipeline is a biometric sample captured by a physical sensor. The engine attempts to match the sample to templates that already exist in the template store or, if no match is found, builds a new template from repeated physical samples and saves the template in the store.


## <span id = "4">4. Biometric Unit Life Cycle</span>    
### <span id = "4.1">4.1 Creation</span>   
When the Windows Biometric Service starts or when it receives a hardware notification from the Plug and Play manager, it scans for any hardware that supports the well-known interface 

{% highlight java %}
GUID_DEVINTERFACE_BIOMETRIC_READER (E2B5183A-99EA-4cc3-AD6B-80CA8D715B80)
{% endhighlight %}

For each biometric device discovered it then:

+ Opens a handle to the device.
+ Queries the device capabilities by using a Windows Biometric Driver control interface.
+ Opens the device registry key and attempts to locate information about any associated adapter plug-ins.
+ Opens the Windows Biometric Service registry key and searches for information about any global plug-ins that should override the device-specific values found in the preceding step.
+ Builds a biometric unit to represent the device and passes the unit to a biometric service provider.  

### <span id = "4.2">4.2 Configuration</span>  
After a biometric service provider (BSP) accepts a biometric unit, it configures the unit and assigns it to a sensor pool. The unit is configured by loading the appropriate adapters, connecting to a template store, and possibly changing the operating mode. A biometric unit can be configured to operate in one of two modes:

+ In the basic mode, the unit acts as a simple capture device. It does not use onboard processing or storage but relies entirely on software adapters for additional support. It should be able to generate samples in a standard format. For example, fingerprint readers should generate samples that comply with `ANSI INCITS 381-2004`. The purpose of the basic mode is to support interoperability among components from different vendors.
+ In the advanced mode, the biometric unit uses onboard processing and storage functions. It must expose the standard interfaces but can generate and process samples in any format desired.

### <span id = "4.3">4.3 Shut Down</span>
When the Windows Biometric Service shuts down or when the Plug and Play manager notifies it that a unit has been removed, the service deletes all biometric units.

## <span id = "5">5. Adapters</span>
Plug-in software components called adapters connect a biometric unit to its underlying hardware and supply any functionality that may be missing from the sensor hardware. There are three types of adapters that you can create:

+ A sensor adapter wraps a biometric device and provides a standard interface for configuring the sensor, capturing samples, and controlling the flow of biometric data to the processing engine.
+ An engine adapter generates biometric templates from captured samples, matches samples to existing templates, and indexes templates.
+ A storage adapter manages template databases.
Adapters can be loaded and unloaded at runtime. This enables the Windows Biometric Service to dynamically reconfigure a biometric unit by connecting it to a different set of adapters.

Finally, each of the sensor, engine and storage adapter interfaces expose two methods, `ControlUnit` and `ControlUnitPrivileged`, that enable client applications to access custom adapter capabilities defined by the vendor. This allows the vendor to define an almost unlimited set of control operations for a device. Further, by choosing which function to implement, a vendor can choose to make some control operations available to non-privileged users while restricting other operations to privileged users.

### <span id = "5.1">5.1 Sensor Adapter Function</span>
A sensor adapter wraps a biometric device and provides a standard interface that enables the Windows Biometric service to **configure the sensor, capture samples, and control the flow of biometric data to the processing engine.** The following functions must be implemented by the developer of the adapter. They are called by the Windows Biometric service.

|Interface|Description
|---|---
|[SensorAdapterAcceptCalibrationData](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_accept_calibration_data_fn)|Passes calibration data from the engine adapter to the sensor adapter.
|[SensorAdapterActivate](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_activate_fn)|Gives the Sensor Adapter the chance to perform any work needed to bring the sensor component out of an idle state.
|[SensorAdapterAttach](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_attach_fn)|Adds a sensor adapter to the processing pipeline of the biometric unit.
|[SensorAdapterCancel](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_cancel_fn)|Cancels all pending sensor operations.
|[SensorAdapterClearContext](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_clear_context_fn)|Prepares the processing pipeline of the biometric unit for a new operation.
|[SensorAdapterControlUnit](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_control_unit_fn)|Performs a vendor-defined control operation that does not require elevated privilege.
|[SensorAdapterControlUnitPrivileged](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_control_unit_privileged_fn)|Performs a vendor-defined control operation that requires elevated privilege.
|[SensorAdapterDeactivate](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_deactivate_fn)|Gives the Sensor Adapter the chance to perform any work needed to put the sensor component into an idle state.
|[SensorAdapterDetach](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_detach_fn)|Releases adapter specific resources attached to the pipeline.
|[SensorAdapterExportSensorData](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_export_sensor_data_fn)|Retrieves the most recently captured biometric sample formatted as a standard [WINBIO_BIR](https://docs.microsoft.com/zh-cn/windows/win32/secbiomet/winbio-bir) structure.
|[SensorAdapterFinishCapture](https://docs.microsoft.com/en-us/windows/win32/api/winbio_adapter/nc-winbio_adapter-pibio_sensor_finish_capture_fn)|Called by the Windows Biometric Framework to wait for the completion of a capture operation initiated by the SensorAdapterStartCapture function.
| [SensorAdapterGetIndicatorStatus](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_get_indicator_status_fn)<br/>           | Retrieves a value that indicates whether the sensor indicator is on or off.<br/>                                                                                       |
| [SensorAdapterNotifyPowerChange](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_notify_power_change_fn)<br/>               | Receives notification about a change in the computer power state and prepares the sensor adapter accordingly.<br/>                                                     |
| [SensorAdapterPipelineCleanup](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_pipeline_cleanup_fn)<br/>                 | Gives the Sensor Adapter the chance to perform any cleanup in that requires help from the Engine or Storage adapter components.<br/>                                   |
| [SensorAdapterPipelineInit](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_pipeline_init_fn)<br/>                       | Gives the Sensor Adapter the chance to perform any initialization that remains incomplete, and which requires help from the Engine or Storage adapter components.<br/> |
| [SensorAdapterPushDataToEngine](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_push_data_to_engine_fn)<br/>               | Makes the current contents of the sample buffer available to the engine adapter.<br/>                                                                                  |
| [SensorAdapterQueryCalibrationFormats](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_query_calibration_formats_fn)<br/> | Determines the set of calibration formats supported by the Sensor Adapter.<br/>                                                                                        |
| [SensorAdapterQueryExtendedInfo](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_query_extended_info_fn)<br/>             | Determines the capabilities and limitations of the biometric sensor component.<br/>                                                                                    |
| [SensorAdapterQueryStatus](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_query_status_fn)<br/>                         | Retrieves information about the current status of the sensor device.<br/>                                                                                              |
| [SensorAdapterReset](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_reset_fn)<br/>                                     | Reinitializes the sensor.<br/>                                                                                                                                         |
| [SensorAdapterSetCalibrationFormat](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_set_calibration_format_fn)<br/>       | Notifies the sensor adapter that a particular calibration data format has been selected by the engine adapter.<br/>                                                    |
| [SensorAdapterSetIndicatorStatus](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_set_indicator_status_fn)<br/>           | Toggles the sensor indicator on or off.<br/>                                                                                                                           |
| [SensorAdapterSetMode](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_set_mode_fn)<br/>                                 | Sets the sensor adapter mode.<br/>                                                                                                                                     |
| [SensorAdapterStartCapture](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_sensor_start_capture_fn)<br/>                       | Begins an asynchronous biometric capture.<br/>                                                                                                                         |
| [WbioQuerySensorInterface](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nf-winbio_adapter-wbioquerysensorinterface)<br/>                         | Retrieves a pointer to the [WINBIO\_SENSOR\_INTERFACE](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/ns-winbio_adapter-winbio_sensor_interface) structure for the sensor adapter.<br/>

### <span id = "5.2">5.2 Engine Adapter Function</span>
An engine adapter generates biometric templates from captured samples, matches samples to existing templates, and indexes templates. The following functions must be implemented by the adapter developer. They are called by the Windows Biometric service.

|Interface|Description
|---|---                                                                                                                                                                                                                                                                                                                                                                           
|[EngineAdapterCreateKey](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_create_key_fn)<br/>                                         |Called by the Windows Biometric Framework to push an HMAC key to the sensor. The returned key identifier will be passed back to the biometric unit when the framework calls [EngineAdapterIdentifyFeatureSetSecure](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_identify_feature_set_secure_fn). <br/>           |
|[EngineAdapterAcceptSampleData](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_accept_sample_data_fn)<br/>                           | Accepts a raw biometric sample and extracts a feature set.<br/>                                                                                                                                                                                                                     |
| [EngineAdapterActivate](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_activate_fn)<br/>                                           | Gives the Engine Adapter the chance to perform any work needed to bring the sensor component out of an idle state.<br/>                                                                                                                                                             |
| [EngineAdapterAttach](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_attach_fn)<br/>                                               | Adds an engine adapter to the processing pipeline of the biometric unit.<br/>                                                                                                                                                                                                       |
| [EngineAdapterCheckForDuplicate](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_check_for_duplicate_fn)<br/>                         | Determines whether a new template in the pipeline duplicates any template already saved in the database regardless of the identity associated with the templates.<br/>                                                                                                              |
| [EngineAdapterClearContext](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_clear_context_fn)<br/>                                   | Prepares the processing pipeline of the biometric unit for a new operation.<br/>                                                                                                                                                                                                    |
| [EngineAdapterCommitEnrollment](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_commit_enrollment_fn)<br/>                           | Finalizes the enrollment object, converts it to a template, and saves the template in the database.<br/>                                                                                                                                                                            |
| [EngineAdapterControlUnit](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_control_unit_fn)<br/>                                     | Performs a vendor-defined control operation that does not require elevated privilege.<br/>                                                                                                                                                                                          |
| [EngineAdapterControlUnitPrivileged](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_control_unit_privileged_fn)<br/>                 | Performs a vendor-defined control operation that requires elevated privilege.<br/>                                                                                                                                                                                                  |
| [EngineAdapterCreateEnrollment](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_create_enrollment_fn)<br/>                           | Initializes the enrollment object in the biometric unit pipeline.<br/>                                                                                                                                                                                                              |
| [EngineAdapterDeactivate](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_deactivate_fn)<br/>                                       | Gives the Engine Adapter the chance to perform any work needed to put the sensor component into an idle state.<br/>                                                                                                                                                                 |
| [EngineAdapterDetach](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_detach_fn)<br/>                                               | Releases adapter-specific resources attached to the pipeline.<br/>                                                                                                                                                                                                                  |
| [EngineAdapterDiscardEnrollment](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_discard_enrollment_fn)<br/>                         | Deletes intermediate enrollment state information from the pipeline.<br/>                                                                                                                                                                                                           |
| [EngineAdapterExportEngineData](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_export_engine_data_fn)<br/>                           | Retrieves a copy of the most recently processed feature set or template from the engine in a standard biometric information record.<br/>                                                                                                                                            |
| [EngineAdapterGetEnrollmentHash](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_get_enrollment_hash_fn)<br/>                         | Retrieves the hash of the completed enrollment template in the pipeline.<br/>                                                                                                                                                                                                       |
| [EngineAdapterGetEnrollmentStatus](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_get_enrollment_status_fn)<br/>                     | Determines whether the enrollment object is ready to be committed to the pipeline.<br/>                                                                                                                                                                                             |
| [EngineAdapterIdentifyAll](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_identify_all_fn)<br/>                                     | Determines the identities of any people who are currently in camera frame.<br/>                                                                                                                                                                                                     |
| [EngineAdapterIdentifyFeatureSet](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_identify_feature_set_fn)<br/>                       | Builds a template from the current feature set and locates a matching template in the database.<br/>                                                                                                                                                                                |
| [EngineAdapterIdentifyFeatureSetSecure](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_identify_feature_set_secure_fn)<br/>           | Called by the Windows Biometric Framework to build a template from the current feature set and locate a matching template in the database. If a match can be found, the engine adapter must fill the *Identity*, *SubFactor*, *Authorization*, and *AuthorizationSize* fields.<br/> |
| [EngineAdapterNotifyPowerChange](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_notify_power_change_fn)<br/>                           | Receives notification about a change in the computer power state and prepares the engine adapter accordingly.<br/>                                                                                                                                                                  |
| [EngineAdapterPipelineCleanup](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_pipeline_cleanup_fn)<br/>                             | Gives the Engine Adapter the chance to perform any cleanup that requires help from the Storage Adapter.<br/>                                                                                                                                                                        |
| [EngineAdapterPipelineInit](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_pipeline_init_fn)<br/>                                   | Gives the Engine Adapter the chance to perform any initialization that remains incomplete.<br/>                                                                                                                                                                                     |
| [EngineAdapterQueryCalibrationData](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_calibration_data_fn)<br/>                   | Gets a set of post-capture calibration data from the engine adapter.<br/>                                                                                                                                                                                                           |
| [EngineAdapterQueryExtendedInfo](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_extended_info_fn)<br/>                         | Determines the capabilities and limitations of the biometric engine component.<br/>                                                                                                                                                                                                 |
| [EngineAdapterQueryHashAlgorithms](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_hash_algorithms_fn)<br/>                     | Retrieves an array of object identifiers that represent the hash algorithms supported by the engine adapter.<br/>                                                                                                                                                                   |
| [EngineAdapterQueryIndexVectorSize](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_index_vector_size_fn)<br/>                   | Retrieves the size of the index vector used by the engine adapter.<br/>                                                                                                                                                                                                             |
| [EngineAdapterQueryPreferredFormat](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_preferred_format_fn)<br/>                   | Determines the input data format preferred by the engine adapter.<br/>                                                                                                                                                                                                              |
| [EngineAdapterQuerySampleHint](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_query_sample_hint_fn)<br/>                             | Retrieves the number of correct samples required by the engine adapter to construct an enrollment template. <br/>                                                                                                                                                                   |
| [EngineAdapterRefreshCache](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_refresh_cache_fn)<br/>                                   | Notifies the Engine Adapter that it should discard any cached templates that it may be keeping in memory.<br/>                                                                                                                                                                      |
| [EngineAdapterSelectCalibrationFormat](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_select_calibration_format_fn)<br/>             | Called by the Windows Biometric Framework to determine which of the Sensor Adapter s calibration formats the Engine Adapter wants to use.<br/>                                                                                                                                      |
| [EngineAdapterSetAccountPolicy](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_set_account_policy_fn)<br/>                           | Sets the extended default and per-user antispoofing policies used by the engine adapter.<br/>                                                                                                                                                                                       |
| [EngineAdapterSetEnrollmentParameters](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_set_enrollment_parameters_fn)<br/>             | Gives the engine adapter additional information about an enrollment operation.<br/>                                                                                                                                                                                                 |
| [EngineAdapterSetEnrollmentSelector](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_set_enrollment_selector_fn)<br/>                 | Tells the Engine Adapter which person to track for the current enrollment operation.<br/>                                                                                                                                                                                           |
| [EngineAdapterSetHashAlgorithm](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_set_hash_algorithm_fn)<br/>                           | Selects a hash algorithm for use in subsequent operations.<br/>                                                                                                                                                                                                                     |
| [EngineAdapterUpdateEnrollment](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_update_enrollment_fn)<br/>                           | Adds the current feature set to the enrollment object.<br/>                                                                                                                                                                                                                         |
| [EngineAdapterVerifyFeatureSet](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_engine_verify_feature_set_fn)<br/>                           | Compares the template in the current feature set with a specific template in the database.<br/>                                                                                                                                                                                     |
| [WbioQueryEngineInterface](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nf-winbio_adapter-wbioqueryengineinterface)<br/>                                     | Retrieves a pointer to the [WINBIO\_ENGINE\_INTERFACE](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/ns-winbio_adapter-winbio_engine_interface) structure for the engine adapter.<br/>                                                                                                                                                      |

### <span id = "5.3">5.3 Storage Adapter Functions</span>
A storage adapter manages template databases. The following functions must be implemented by the adapter developer. They are called by the Windows Biometric service.

|Interface|Description
|---|---
| [StorageAdapterActivate](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_activate_fn)<br/>                           | Gives the Storage Adapter the chance to perform any work needed to bring the storage component out of an idle state.<br/>         |
| [StorageAdapterAddRecord](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_add_record_fn)<br/>                         | Adds a template to the database.<br/>                                                                                             |
| [StorageAdapterAttach](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_attach_fn)<br/>                               | Adds a storage adapter to the processing pipeline of the biometric unit.<br/>                                                     |
| [StorageAdapterClearContext](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_clear_context_fn)<br/>                   | Prepares the processing pipeline of the biometric unit for a new operation.<br/>                                                  |
| [StorageAdapterCloseDatabase](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_close_database_fn)<br/>                 | Closes the database associated with the pipeline and frees all related resources.<br/>                                            |
| [StorageAdapterControlUnit](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_control_unit_fn)<br/>                     | Performs a vendor-defined control operation that does not require elevated privilege.<br/>                                        |
| [StorageAdapterControlUnitPrivileged](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_control_unit_privileged_fn)<br/> | Performs a vendor-defined control operation that requires elevated privilege.<br/>                                                |
| [StorageAdapterCreateDatabase](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_create_database_fn)<br/>               | Creates and configures a new database.<br/>                                                                                       |
| [StorageAdapterDeactivate](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_deactivate_fn)<br/>                       | Gives the Storage Adapter the chance to perform any work needed to put the storage component into an idle state.<br/>             |
| [StorageAdapterDeleteRecord](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_delete_record_fn)<br/>                   | Deletes one or more templates from the database.<br/>                                                                             |
| [StorageAdapterDetach](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_detach_fn)<br/>                               | Releases adapter-specific resources attached to the pipeline.<br/>                                                                |
| [StorageAdapterEraseDatabase](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_erase_database_fn)<br/>                 | Erases the database and marks it for deletion.<br/>                                                                               |
| [StorageAdapterFirstRecord](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_first_record_fn)<br/>                     | Positions the result set cursor on the first record in the set.<br/>                                                              |
| [StorageAdapterGetCurrentRecord](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_get_current_record_fn)<br/>           | Retrieves the contents of the current record in the pipeline result set.<br/>                                                     |
| [StorageAdapterGetDatabaseSize](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_get_database_size_fn)<br/>             | Retrieves the database size and available space.<br/>                                                                             |
| [StorageAdapterGetDataFormat](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_get_data_format_fn)<br/>                 | Retrieves format and version information used by the current database associated with the pipeline.<br/>                          |
| [StorageAdapterGetRecordCount](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_get_record_count_fn)<br/>               | Retrieves the number of template records in the pipeline result set.<br/>                                                         |
| [StorageAdapterNextRecord](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_next_record_fn)<br/>                       | Advances the result set cursor by one record.<br/>                                                                                |
| [StorageAdapterNotifyPowerChange](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_notify_power_change_fn)<br/>           | Receives notification about a change in the computer power state and prepares the storage adapter accordingly.<br/>               |
| [StorageAdapterOpenDatabase](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_open_database_fn)<br/>                   | Opens a database for use by the storage adapter.<br/>                                                                             |
| [StorageAdapterPipelineCleanup](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_pipeline_cleanup_fn)<br/>             | Gives the Storage Adapter the chance to perform any cleanup in preparation for closing the template database.<br/>                |
| [StorageAdapterPipelineInit](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_pipeline_init_fn)<br/>                   | Gives the Storage Adapter the chance to perform any initialization that remains incomplete.<br/>                                  |
| [StorageAdapterQueryByContent](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_query_by_content_fn)<br/>               | Queries the database that is currently open for templates associated with a specified index vector.<br/>                          |
| [StorageAdapterQueryBySubject](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_query_by_subject_fn)<br/>               | Queries the database that is currently open for templates associated with a specified identity and sub-factor.<br/>               |
| [StorageAdapterQueryExtendedInfo](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nc-winbio_adapter-pibio_storage_query_extended_info_fn)<br/>         | Determines the capabilities and limitations of the biometric storage component.<br/>                                              |
| [WbioQueryStorageInterface](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/nf-winbio_adapter-wbioquerystorageinterface)<br/>                     | Retrieves a pointer to the [WINBIO\_STORAGE\_INTERFACE](https://docs.microsoft.com/en-us/windows/win32/api/Winbio_adapter/ns-winbio_adapter-winbio_storage_interface) structure for the storage adapter.<br/> |


## <span id = "6">6. IOCTLs Interface of Biometric</span>
WBDI is a Windows standard IOCTL-based interface. When you write a WBDI driver, you must support a set of mandatory IOCTLs. You may additionally choose to support optional IOCTLs. 
+ Biometric [winbio_ioctl.h]() contains the following programming IOCTLs interfaces:

### <span id = "6.1">6.1 IOCTLs</span>

|Interface|Description
|---|---
| [IOCTL_BIOMETRIC_CALIBRATE](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_calibrate)<br/>               | The IOCTL_BIOMETRIC_CALIBRATE IOCTL directs the driver to perform any necessary steps to calibrate the device for use.<br/>               |
| [IOCTL_BIOMETRIC_CAPTURE_DATA](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_capture_data)<br/>               | The IOCTL_BIOMETRIC_CAPTURE_DATA IOCTL directs the driver to retrieve the next scan of biometric data. This call should put the device into capture mode.Vendor-supplied WBDI drivers must support IOCTL_BIOMETRIC_CAPTURE_DATA.<br/>               |
| [IOCTL_BIOMETRIC_GET_ATTRIBUTES](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_attributes)<br/>               | The IOCTL_BIOMETRIC_GET_ATTRIBUTES IOCTL returns a structure that contains a set of attributes for the sensor. Vendor-supplied WBDI drivers must support this IOCTL.<br/>               |
| [IOCTL_BIOMETRIC_GET_INDICATOR](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_indicator)<br/>               | The IOCTL_BIOMETRIC_GET_INDICATOR IOCTL directs the driver to retrieve the status of the indicator light. This IOCTL is optional.<br/>               |
| [IOCTL_BIOMETRIC_GET_SENSOR_STATUS](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_sensor_status)<br/>               | The IOCTL_BIOMETRIC_GET_SENSOR_STATUS IOCTL tells the driver to perform any necessary steps to collect the current operating status of the device. Vendor-supplied WBDI drivers must support this IOCTL.<br/>               |
| [IOCTL_BIOMETRIC_RESET](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_reset)<br/>               | The IOCTL_BIOMETRIC_RESET IOCTL resets the device to a known or idle state, according to the current power state. Vendor-supplied WBDI drivers must support this IOCTL.<br/>               |
| [IOCTL_BIOMETRIC_SET_INDICATOR](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_set_indicator)<br/>               | The IOCTL_BIOMETRIC_SET_INDICATOR IOCTL directs the driver to update the status of the indicator light.<br/>               |
| [IOCTL_BIOMETRIC_UPDATE_FIRMWARE](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_update_firmware)<br/>               | The IOCTL_BIOMETRIC_UPDATE_FIRMWARE IOCTL tells the driver to update the firmware for the device with the given firmware image. This IOCTL is optional.<br/>               |

### <span id = "6.2">6.2 Biometric IOCTLs Calling Sequence</span>
A vendor-supplied WBDI driver should be prepared to receive IOCTL requests in the following order from the Windows Biometric Service (WBS). You can review examples of handlers for these IOCTLs in Device.cpp in [WudfBioUsbSample](https://github.com/Microsoft/Windows-driver-samples/tree/master/biometrics/driver).

1. The Windows Biometric Service or the sensor adapter initializes the biometric device and verifies that it is ready for use. The service or adapter sends an [IOCTL_BIOMETRIC_GET_ATTRIBUTES](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_attributes) request.<br/>
The driver receives a pointer to a [WINBIO_SENSOR_ATTRIBUTES](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ns-winbio_ioctl-_winbio_sensor_attributes) structure. In the handler for this IOCTL, the driver should fill in the relevant members of this structure and complete the request by calling [IWDFIoRequest::Complete](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wudfddi/nf-wudfddi-iwdfiorequest-complete).

2. Next, the driver receives [IOCTL_BIOMETRIC_GET_SENSOR_STATUS](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_sensor_status). The driver should fill in the relevant members of the [WINBIO_DIAGNOSTICS](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ns-winbio_ioctl-_winbio_diagnostics) structure and complete the request.

3. If the driver indicates that calibration is necessary in the SensorStatus member of the [WINBIO_DIAGNOSTICS](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ns-winbio_ioctl-_winbio_diagnostics) structure that was returned from the [IOCTL_BIOMETRIC_GET_SENSOR_STATUS](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_get_sensor_status) request, the driver next receives an [IOCTL_BIOMETRIC_CALIBRATE](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_calibrate) request. The driver must provide a handler for this IOCTL. After calibrating the device, the callback should return a [WINBIO_CALIBRATION_INFO](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ns-winbio_ioctl-_winbio_calibration_info) structure.

4. The driver can now expect to receive [IOCTL_BIOMETRIC_CAPTURE_DATA](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_capture_data) requests. Because only one capture can be pending at any time, the handler for this request should first confirm that no request is pending. If a request is pending, complete the request with WINBIO_E_DATA_COLLECTION_IN_PROGRESS.<br/> 
The WinBio service or an application can request cancellation of an outstanding capture request at any time by calling Win32 cancellation routines such as [CancelIo](https://docs.microsoft.com/zh-cn/windows/win32/fileio/cancelio), [CancelIoEx](https://docs.microsoft.com/zh-cn/windows/win32/fileio/cancelioex-func), or [CancelSynchronousIo](https://docs.microsoft.com/zh-cn/windows/win32/fileio/cancelsynchronousio-func). As such, WBDI drivers must also support cancellation.<br/> 
The driver handles cancellation by calling [IWDFIoRequest::MarkCancelable](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wudfddi/nf-wudfddi-iwdfiorequest-markcancelable) to register an [IRequestCallbackCancel](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wudfddi/nn-wudfddi-irequestcallbackcancel) interface.<br/> 
The handler then programs the device for capture mode and returns from the callback. The request should remain pending until canceled or the driver detects that the capture is complete. After this I/O request is completed, the device can return to an idle state. A client may make an initial call to IOCTL_BIOMETRIC_CAPTURE_DATA to determine the correct buffer size for an actual capture.<br/> 

5. The handler for [IOCTL_BIOMETRIC_RESET](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ni-winbio_ioctl-ioctl_biometric_reset) should physically reset the device to a known or idle state. The handler for this request must also cancel any pending data collection I/O and fill out the [WINBIO_BLANK_PAYLOAD](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/winbio_ioctl/ns-winbio_ioctl-_winbio_blank_payload) structure. The handler then completes the request. Clients do not need to call reset between calls to IOCTL_BIOMETRIC_CAPTURE_DATA.