<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords"  content="董刚, DavidDong, David, 董刚的博客, David Dong's Blog, 博客, 个人网站, 互联网, Web, 手机, 人机接口, Touch, Fingerprint，Github Pages TEE Java Python C Android">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Fingerprint implementation in android 8.0 and later | David Dong’s Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Fingerprint implementation in android 8.0 and later" />
<meta name="author" content="david.dong" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Fingerprint framework of Android 8.0 introduction." />
<meta property="og:description" content="Fingerprint framework of Android 8.0 introduction." />
<link rel="canonical" href="http://localhost:4000/android/fingerprint/2020/01/09/Fingerprint-impl-AN8.0.html" />
<meta property="og:url" content="http://localhost:4000/android/fingerprint/2020/01/09/Fingerprint-impl-AN8.0.html" />
<meta property="og:site_name" content="David Dong’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-09T20:59:29+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fingerprint implementation in android 8.0 and later" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"david.dong"},"dateModified":"2020-01-09T20:59:29+08:00","datePublished":"2020-01-09T20:59:29+08:00","description":"Fingerprint framework of Android 8.0 introduction.","headline":"Fingerprint implementation in android 8.0 and later","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/android/fingerprint/2020/01/09/Fingerprint-impl-AN8.0.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/logo.png"},"name":"david.dong"},"url":"http://localhost:4000/android/fingerprint/2020/01/09/Fingerprint-impl-AN8.0.html"}</script>
<!-- End Jekyll SEO tag -->



<meta property="article:tag" content="Android">

<meta property="article:tag" content="Fingerprint">


<link href="https://fonts.font.im/css?family=Poppins:400,900|Raleway|Roboto:400,900|Roboto+Mono&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="icon" href="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/favicon.ico">

	<!-- default stylesheet monokai.sublime ! -->
	
	<link href="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/css/syntax/syntax.monokai.sublime.css" rel="stylesheet"/>
	

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js"></script>

</head><body>
    <main class="container">
      <section class="about condensed">
	    <div class="about-header condensed">
			<div class="about-title">
				<a href="/blog/index.html">
				  <img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/avatar-11.png" alt="David Dong"/>
				</a>
				<div class = "title-meta">
					<h2 id="title">
					  <a href="/blog/index.html">David Dong</a>
					</h2>
					<p class = "tagline-small">Java/C/C#/Python</p>
				</div>
			</div>
			<p class="tagline">Java/C/C#/Python</p>
		</div>
		<!--put dark mode button here -->
		<div class = "about-footer condensed">
		  <!--put rss/code link here -->
			<div class="icon-box-container about-footer condensed"><div class = "icon-box" style = "padding-right:0px">
					<a id="dark-mode-toggle" class="togglemode dark-mode" onclick="toggleDarkMode()">
						<span id = "mode">Dark Mode</span>
					</a>
				</div>
				<!-- toggle dark/light display mode, should loading darkmode.js here for avoiding flicker when switching -->
				<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/js/darkmode.js"></script>
				<script type="text/javascript">
				$('.dark-mode').on('click',function(){
					$('.dark-mode').toggleClass('light-mode');
					if (document.getElementById("mode").innerHTML=="Light Mode")
						document.getElementById("mode").innerHTML="Dark Mode";
					else 
						document.getElementById("mode").innerHTML="Light Mode";
				})
				</script><div class = "icon-box">
					<a class="icon-rss" href="/rss.xml">
						<span>Subscribe</span>
					</a>
				</div><div class = "icon-box">
					<a class="icon-file-code" href="https://github.com/gangdong/gangdong.github.io">
						<span>Source Code</span>
					</a>
				</div></div>
		</div>
		
	    <!--show contact me -->
		<div class = "about-footer condensed social-container">
	    <p class = "contact about-footer condensed">CONTACT ME</p>
		<!-- put social link here -->
	      <ul class="social about-footer condensed" >
		   <a href="https://rainbow-ux.github.io/traveler-blog.github.io">
              <li>
                <i class="icon-picture"></i>
              </li>
           </a><a href="https://github.com/gangdong">
              <li>
                <i class="icon-github-circled"></i>
              </li>
            </a><a href="https://www.linkedin.com/in/刚-董-25208ba0/">
              <li>
                <i class="icon-linkedin-squared"></i>
              </li>
            </a><a href="mailto:dqdongg@hotmail.com">
              <li>
                <i class="icon-mail" style = "font-size: 27px"></i>
              </li>
            </a></ul>
		<!--put timestamp here -->
		<p class ="timestamp about-footer condensed">&copy; 2024</p>
		</div>
	  <!-- about box end here -->
      </section>
	  
      <section class="content">
        


<!-- add menu bar here! -->
<div class="post-container">
	<div  class = "menu-meta condensed">
		<!--put top menu here, display @ big screen (> $mobileW) -->
		<div  class = "menu-logo">BLOG</div>
		<div  class = "menu">
			<a href="/blog/index.html">
				<li class="icon-home">Home</li>
			</a><a href="/archive">
				<li class="icon-archive">Archives</li>
			</a><a href="/category">
				<li class="icon-tags">Categories</li>
			</a><a href="/about">
				<li class="icon-help-circled">About</li>
			</a>
		</div>
		<!--put hide menu button here, display @ small screen (< $mobileW) -->
		<div class = "menu-btn-box"><a class="menu-btn"></a></div>
		<!--put hide menu here, display @ small screen (< $mobileW) -->
		<div class="context-menu">
			<ul >
				<li>
					<a class="icon-home" href="/blog/index.html">Home</a>
				</li><li>
					<a class="icon-archive" href="/archive">Archives</a>
				</li><li>
					<a class="icon-tags" href="/category">Categories</a>
				</li><li>
					<a class="icon-help-circled" href="/about">About</a>
				</li>
			</ul>
		</div>
	</div>
</div>
<script type="text/javascript">
$('.menu-btn').on('click',function(e){
		
	e.stopPropagation();
	var tag = $('.context-menu');		
	$(tag).toggleClass('context-menu-show');
			
	var flag = true;
	/* hide the context-menu when other element is clicked */
	$(document).bind('click',function(e){
		var target = $(e.target);
		if(target.closest(tag).length == 0 && flag == true){
			$(tag).toggleClass('context-menu-show');
			flag = false;
		}
	});
})
</script><div class="post-container" style = "margin-bottom:1rem">
	<div class="posts-labelgroup" id="posts-labelgroup">
		<h1 id="posts-label">POST</h1>
	</div>  
	<!-- post title -->
	<h2 class="post-title-body">Fingerprint implementation in android 8.0 and later</h2>
	<div class="post-meta">
		<div class="post-date icon-calendar" style = "padding-left:0px;font-size:14px">Jan 9, 2020</div>
		
		<!-- sidebar button for displaying/hiding sidebar -->
		<div class = "sidebar-btn-box"><a class="btn"></a></div>
		
	</div>
</div>
  <!-- post content here! -->
  <!-- set fix width box to put content! -->
<div class="post-viewer-container">
	<div class="post post-fix-width">
		<p>Since Android 8.0, Android has fully introduced the HIDL layer into the framework. The purpose is to separate vendor partition from system partition so that Android is capable to upgrade the framework through OTA without recompiling HAL. Correspondingly, the framework of fingerprint has also been reconstructed. 
This page will give an introduction about the difference in the fingerprint framework between android 7.0 (<em>and early version</em>) and android 8.0 (<em>and later version</em>).</p>

<p>After the study of the previous three articles, <br />
<a href="/android/fingerprint/2019/10/03/Fingerprint-frmk1.html">Android Fingerprint Framework (1)</a><br />
<a href="/android/fingerprint/2019/12/07/Fingerprint-frmk2.html">Android Fingerprint Framework (2)</a><br />
<a href="/android/fingerprint/2019/12/21/Fingerprint-frmk3.html">Android Fingerprint Framework (3)</a><br /></p>

<p>we have discussed the fingerprint framework on android 7.0 in previous blogs, here give a summary for anyone who has not read these articles yet. <br /></p>

<h2 id="fingerprint-framework-in-android-70">fingerprint framework in Android 7.0</h2>
<p>This diagram is the fingerprint framework on the android platform, which I have presented in another article and copied here.</p>

<p><img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/image/android-fingerprint-framework-framework.png" alt="framework" class="center-image" /></p>

<p>From the top layer, the fingerprint application will start the workflow and this is the fingerprint management entry defined by the Android system layer.
In the framework internal, some tasks will be done to handle the request from the application.</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">init.rc</code> starts up the <code class="language-plaintext highlighter-rouge">Fingerprintd</code> process during the system boot-up. <code class="language-plaintext highlighter-rouge">Fingerpringd</code> then register <code class="language-plaintext highlighter-rouge">IFingerprintDaemon</code> remote service to <code class="language-plaintext highlighter-rouge">ServiceManager</code>.</p>
  </li>
  <li>
    <p>System Server will start fingerprint system service <code class="language-plaintext highlighter-rouge">FingerprintService</code>.<br />
<strong>SystemServer.java</strong></p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">mSystemServiceManager</span><span class="p">.</span><span class="n">startService</span><span class="p">(</span><span class="n">FingerprintService</span><span class="p">.</span><span class="k">class</span><span class="p">);</span></code></pre></figure>

<ol>
  <li><code class="language-plaintext highlighter-rouge">FingerprintService</code> calls the interface of <code class="language-plaintext highlighter-rouge">Fingerprintd</code> to communicate with Fingerprint HAL layer.<br />
<strong>FingerprintService.java</strong></li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">public</span> <span class="n">IFingerprintDaemon</span> <span class="nf">getFingerprintDaemon</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mDaemon</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mDaemon</span> <span class="o">=</span> <span class="n">IFingerprintDaemon</span><span class="p">.</span><span class="n">Stub</span><span class="p">.</span>
            <span class="n">asInterface</span><span class="p">(</span><span class="n">ServiceManager</span><span class="p">.</span><span class="n">getService</span><span class="p">(</span><span class="n">FINGERPRINTD</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mDaemon</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">mDaemon</span><span class="p">.</span><span class="n">asBinder</span><span class="p">().</span><span class="n">linkToDeath</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="n">mDaemon</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">mDaemonCallback</span><span class="p">);</span>
                    <span class="n">mHalDeviceId</span> <span class="o">=</span> <span class="n">mDaemon</span><span class="p">.</span><span class="n">openHal</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mHalDeviceId</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">updateActiveGroup</span><span class="p">(</span><span class="n">ActivityManager</span><span class="p">.</span><span class="n">getCurrentUser</span><span class="p">(),</span> <span class="n">null</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">Slog</span><span class="p">.</span><span class="n">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Failed to open Fingerprint HAL!"</span><span class="p">);</span>
                        <span class="n">MetricsLogger</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">mContext</span><span class="p">,</span>
                        <span class="s">"fingerprintd_openhal_error"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                        <span class="n">mDaemon</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Slog</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Failed to open fingeprintd HAL"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                    <span class="n">mDaemon</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span> <span class="c1">// try again later!</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">Slog</span><span class="p">.</span><span class="n">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"fingerprint service not available"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">mDaemon</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Fingerprintd</code> calls <code class="language-plaintext highlighter-rouge">FingerprintDaemonProxy</code> function to open HAL.<br />
<strong>FingerprintDaemonProxy.cpp</strong></li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int64_t</span> <span class="n">FingerprintDaemonProxy</span><span class="o">::</span><span class="n">openHal</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ALOG</span><span class="p">(</span><span class="n">LOG_VERBOSE</span><span class="p">,</span> <span class="n">LOG_TAG</span><span class="p">,</span> <span class="s">"nativeOpenHal()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">hw_module_t</span> <span class="o">*</span><span class="n">hw_module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">hw_get_module</span><span class="p">(</span><span class="n">FINGERPRINT_HARDWARE_MODULE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_module</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't open fingerprint HW Module, error: %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">hw_module</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"No valid fingerprint module"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">mModule</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">fingerprint_module_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">hw_module</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mModule</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"No valid open method"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hw_device_t</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">mModule</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">hw_module</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't open fingerprint methods, error: %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">kVersion</span> <span class="o">!=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Wrong fp version. Expected %d, got %d"</span><span class="p">,</span> <span class="n">kVersion</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
        <span class="c1">// return 0; // FIXME</span>
    <span class="p">}</span>

    <span class="n">mDevice</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">fingerprint_device_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">set_notify</span><span class="p">(</span><span class="n">mDevice</span><span class="p">,</span> <span class="n">hal_notify_callback</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Failed in call to set_notify(), err=%d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Sanity check - remove</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">notify</span> <span class="o">!=</span> <span class="n">hal_notify_callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"NOTIFY not set properly: %p != %p"</span><span class="p">,</span> <span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">,</span> 
        <span class="n">hal_notify_callback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ALOG</span><span class="p">(</span><span class="n">LOG_VERBOSE</span><span class="p">,</span> <span class="n">LOG_TAG</span><span class="p">,</span> <span class="s">"fingerprint HAL successfully initialized"</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mDevice</span><span class="p">);</span> <span class="c1">// This is just a handle</span>
<span class="p">}</span></code></pre></figure>

<ol>
  <li>The HAL code is at below android path normally.<br /></li>
</ol>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/hardware/</span><span class="n">libhardware</span><span class="o">/</span><span class="kp">include</span><span class="sr">/hardware/</span><span class="n">fingerprint</span><span class="p">.</span><span class="nf">h</span>
<span class="sr">/hardware/</span><span class="n">libhardware</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">fingerprint</span><span class="p">.</span><span class="nf">c</span></code></pre></figure>

<p>I drew a flow chart to help understand the whole flow more clearly.</p>

<p><img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/image/android-fingerprint-android8-workflow.png" alt="workflow" /></p>

<p>The related source code and android path can be found in the below table. Android 7.0 (NOUGAT)<br /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">File</th>
      <th style="text-align: center">Android Path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/system/core/rootdir/init.rc">init.rc</a></td>
      <td style="text-align: center">root/system/core/rootdir/init.rc</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/system/core/fingerprintd/fingerprintd.cpp">fingerprintd.cpp</a></td>
      <td style="text-align: center">root/system/core/fingerprintd/fingerprintd.cpp</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/system/core/fingerprintd/FingerprintDaemonProxy.h">FingerprintDaemonProxy.h</a></td>
      <td style="text-align: center">root/system/core/fingerprintd/</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/system/core/fingerprintd/FingerprintDaemonProxy.cpp">fingerprintdaemonproxy.cpp</a></td>
      <td style="text-align: center">root/system/core/fingerprintd/fingerprintdaemonproxy.cpp</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/frameworks/base/services/java/com/android/server/SystemServer.java">SystemServer.java</a></td>
      <td style="text-align: center">root/frameworks/base/services/java/com/android/server/SystemServer.java</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/frameworks/base/services/core/java/com/android/server/fingerprint/FingerprintService.java">FingerprintService.java</a></td>
      <td style="text-align: center">root/frameworks/base/services/core/<br />java/com/android/server/fingerprint/FingerprintService.java</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/hardware/libhardware/include/hardware/hardware.h">hardware.h</a></td>
      <td style="text-align: center">root/hardware/libhardware/include/hardware/hardware.h</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/7.0.0_r31/xref/hardware/libhardware/hardware.c">hardware.c</a></td>
      <td style="text-align: center">root/hardware/libhardware/hardware.c</td>
    </tr>
  </tbody>
</table>

<h2 id="fingerprint-framework-in-android-80">fingerprint framework in Android 8.0</h2>
<p>Above is the fingerprint framework of Android 7.0, however in Android 8.0 and later versions, Android has updated the framework and introduced a set of languages called HIDL to define the interface between framework and HAL.</p>

<p>Let’s see the difference.</p>

<p><img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/image/android-fingerprint-framework-android8-diff.png" alt="hidl" class="center-image" /></p>

<p>Android 8.0 adds a sub-directory <code class="language-plaintext highlighter-rouge">/interface</code> in the <code class="language-plaintext highlighter-rouge">/hardware</code> directory, which includes all HIDL files for the hardware module.</p>

<p>Android 8.0 removed <code class="language-plaintext highlighter-rouge">Fingerprintd</code>, instead, <code class="language-plaintext highlighter-rouge">FingerprintService</code> accesses HAL by calling HIDL.</p>

<p>We can find the change in <code class="language-plaintext highlighter-rouge">getFingerprintDaemon()</code> method.</p>

<p>In Android 7.0<br />
<strong>FingerprintService.java</strong></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">mDaemon</span> <span class="o">=</span> <span class="n">IFingerprintDaemon</span><span class="p">.</span><span class="n">Stub</span><span class="p">.</span><span class="n">asInterface</span><span class="p">(</span><span class="n">ServiceManager</span><span class="p">.</span>
<span class="n">getService</span><span class="p">(</span><span class="n">FINGERPRINTD</span><span class="p">));</span></code></pre></figure>

<p>While in Android 8.0, mDaemon is achieved from the service of <code class="language-plaintext highlighter-rouge">IBiometricsFingerprint</code>.<br />
<strong>FingerprintService.java</strong></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">mDaemon</span> <span class="o">=</span> <span class="n">IBiometricsFingerprint</span><span class="p">.</span><span class="n">getService</span><span class="p">();</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">IBiometricsFingerprint</code> is a new fingerprint HIDL interface that was introduced on Android 8.0. <br />
<a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/IBiometricsFingerprint.hal">IBiometricsFingerprint.hal</a>
use HIDL language format defined a series of standard fingerprint operation interfaces. 
And <a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/BiometricsFingerprint.cpp">biometricsfingerprint.cpp</a> class realized the <code class="language-plaintext highlighter-rouge">IBiometricsFingerprint</code> interface.</p>

<p>We may notice that the <code class="language-plaintext highlighter-rouge">IBiometricsFingerprint</code> returns a service for caller, actually there is a  file in the HIDL sub-directory: <br />
<a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/android.hardware.biometrics.fingerprint@2.1-service.rc">android.hardware.biometrics.fingerprint@2.1-service.rc</a>, which will start fps_hal service.<br />
<strong>fingerprint@2.1-service.rc</strong></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"> <span class="n">service</span> <span class="n">fps_hal</span> <span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">android</span><span class="p">.</span><span class="n">hardware</span><span class="p">.</span><span class="n">biometrics</span><span class="p">.</span><span class="n">fingerprint</span><span class="err">@</span><span class="mf">2.1</span><span class="o">-</span><span class="n">service</span>
    <span class="cp"># "class hal" causes a race condition on some devices due to files created
</span>    <span class="cp"># in /data. As a workaround, postpone startup until later in boot once
</span>    <span class="cp"># /data is mounted.
</span>    <span class="k">class</span> <span class="nc">late_start</span>
    <span class="n">user</span> <span class="n">system</span>
    <span class="n">group</span> <span class="n">system</span> <span class="n">input</span></code></pre></figure>

<p>The files of the fingerprint HIDL related.
<img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/image/android-fingerprint-android8-hidl.png" alt="hidl file" /></p>

<p>If we look at the <strong>Service.cpp</strong>, we will find the service actually will create a <code class="language-plaintext highlighter-rouge">BiometricsFingerprint</code> instance and register as service.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">android</span><span class="o">::</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IBiometricsFingerprint</span><span class="o">&gt;</span> <span class="n">bio</span> <span class="o">=</span> <span class="n">BiometricsFingerprint</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>

    <span class="n">configureRpcThreadpool</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/*callerWillJoin*/</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bio</span><span class="o">-&gt;</span><span class="n">registerAsService</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't create instance of BiometricsFingerprint, nullptr"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">joinRpcThreadpool</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// should never get here</span>
<span class="p">}</span></code></pre></figure>

<p>In the constructor of <code class="language-plaintext highlighter-rouge">BiometricsFingerprint</code> class, it calls <code class="language-plaintext highlighter-rouge">openHal()</code> to open HAL module. <br />
<strong>BiometricsFingerprint.cpp</strong></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">BiometricsFingerprint</span><span class="o">::</span><span class="n">BiometricsFingerprint</span><span class="p">()</span> <span class="o">:</span> <span class="n">mClientCallback</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">),</span> 
<span class="n">mDevice</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sInstance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span> <span class="c1">// keep track of the most recent instance</span>
    <span class="n">mDevice</span> <span class="o">=</span> <span class="n">openHal</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't open HAL module"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Let’s check the <code class="language-plaintext highlighter-rouge">openHal()</code> function.<br />
<strong>BiometricsFingerprint.cpp</strong></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">fingerprint_device_t</span><span class="o">*</span> <span class="n">BiometricsFingerprint</span><span class="o">::</span><span class="n">openHal</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">hw_module_t</span> <span class="o">*</span><span class="n">hw_mdl</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="n">ALOGD</span><span class="p">(</span><span class="s">"Opening fingerprint hal library..."</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">hw_get_module</span><span class="p">(</span><span class="n">FINGERPRINT_HARDWARE_MODULE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_mdl</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't open fingerprint HW Module, error: %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hw_mdl</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"No valid fingerprint module"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fingerprint_module_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">fingerprint_module_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">hw_mdl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"No valid open method"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hw_device_t</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">hw_mdl</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't open fingerprint methods, error: %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">kVersion</span> <span class="o">!=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// enforce version on new devices because of HIDL@2.1 translation layer</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Wrong fp version. Expected %d, got %d"</span><span class="p">,</span> <span class="n">kVersion</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fingerprint_device_t</span><span class="o">*</span> <span class="n">fp_device</span> <span class="o">=</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">fingerprint_device_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span>
            <span class="n">fp_device</span><span class="o">-&gt;</span><span class="n">set_notify</span><span class="p">(</span><span class="n">fp_device</span><span class="p">,</span> <span class="n">BiometricsFingerprint</span><span class="o">::</span><span class="n">notify</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Can't register fingerprint module callback, error: %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">fp_device</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Have you found that the function realization is similar to the <code class="language-plaintext highlighter-rouge">FingerprintDaemonProxy::openHal()</code>? The native method is called and the HAL module is opened here. After access to the HAL, others are all same under the HAL layer.</p>

<p>So far, we can change the fingerprint framework of Android 8.0 as below.</p>

<p><img src="https://cdn.jsdelivr.net/gh/gangdong/gangdong.github.io@dev/assets/image/android-fingerprint-android8-workflow2.png" alt="fingerprint framework android8.0" class="center-image" /></p>

<p>Compare this flowchart carefully with the last flowchart above, we can find the difference.</p>

<p>The related source code and android path can be found in the below table<br /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">File</th>
      <th style="text-align: center">Android Path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/android.hardware.biometrics.fingerprint@2.1-service.rc">fingerprint@2.1-service</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1/default</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/service.cpp">service.cpp</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1/default</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/BiometricsFingerprint.h">BiometricsFingerprint.h</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1/default</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/default/BiometricsFingerprint.cpp">BiometricsFingerprint.cpp</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1/default</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/IBiometricsFingerprint.hal">IBiometricsFingerprint.hal</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1</td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="https://www.androidos.net.cn/android/8.0.0_r4/xref/hardware/interfaces/biometrics/fingerprint/2.1/IBiometricsFingerprintClientCallback.hal">IBiometricsFingerprintClientCallback.hal</a></td>
      <td style="text-align: center">root/hardware/interfaces/biometrics/fingerprint/2.1</td>
    </tr>
  </tbody>
</table>

<p>Now, I think the main difference of the fingerprint framework on Android 8.0 has been introduced and if you have further questions, you can ask in the comment box, I will reply to you as soon as I can.</p>

	</div>
	<!-- put sidebar! -->
	
	<div class = "sidebar-container">
	    
	    <div class = "sidebar-about-box" id = "sidebar">
		    
				<p class = "sidebar-title">About This Article</p>
			
			
				
					<P class = "sidebar-about-content sidebar-font-big">Fingerprint framework of Android 8.0 introduction.</P>
				
				
					<P class = "icon-link sidebar-about-content sidebar-font-medium" style = "margin-top:30px">Author: <a href="https://github.com/gangdong">david.dong</a></P>
				
					<P class = "icon-clock sidebar-about-content sidebar-font-medium">22 mins to read</P>
					<P class = "icon-book-1 sidebar-about-content sidebar-font-medium">8617 words</P>
				
					<P class = "icon-th-list sidebar-about-content sidebar-font-medium">Key Words: Fingerprint framework/Android 8.0</P>
				
				
				    <P class = "icon-hashtag sidebar-about-content sidebar-font-medium">Tags: 
					
					<a href="/category#Android">Android&nbsp;</a>
					
					<a href="/category#Fingerprint">Fingerprint&nbsp;</a>
					
					</P>
				
			
		</div>
		
		
	    <div class="sidebar-toc-box">
			
			<p class = "sidebar-title">Table of Contents</p>
			<span class = "sidebar-font-medium sidebar-toc-content"><ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#fingerprint-framework-in-android-70">fingerprint framework in Android 7.0</a></li>
<li class="toc-entry toc-h2"><a href="#fingerprint-framework-in-android-80">fingerprint framework in Android 8.0</a></li>
</ul></span>
			
		</div>
		
	</div>
	 
</div>
<!-- no sidebar, use flex width box! -->
<br>
<div class="post-container">
    <!-- post categories box! here  -->
    
   <div class="post-categories-meta">
		<div class="post-categories-box post-categories-box-hide"><a href="/category#Android">Android</a><a href="/category#Fingerprint">Fingerprint</a></div>
	</div>
  
  
  <div class = "share-box-meta">
  <!-- Go to www.addthis.com/dashboard to customize your tools -->
	
	<div class="addthis_inline_share_toolbox share-box"><span style ="padding: 2px">Share:</span></div>
	
	<!-- Put post veiw statistic here! -->
	<div class = "post-view">
	
		<span class = "icon-eye tooltip"><p class = "tooltiptext" style = "left:0%; margin-left: 0px">Viewers</p><span id="busuanzi_value_page_pv"></span></span>
		
	</div>
  </div>
  
  <!-- Related posts start here! -->
		
		<h1 id="posts-label">You may also like</h1>
		
	  <div class = "related-posts-box">
		<ul>
			
			<li><a href="/android/fingerprint/2021/02/04/Fingerprint-build-ta.html">Build TA images on different TEE</a></li>
			
			<li><a href="/android/fingerprint/2020/12/02/Fingerprint-Trusty.html">Some useful knowledge for Fingerprint Application on Trusty TEE</a></li>
			
			<li><a href="/android/fingerprint/2019/12/21/Fingerprint-frmk3.html">Android Fingerprint Framework (3)</a></li>
			
			<li><a href="/android/fingerprint/2019/12/07/Fingerprint-frmk2.html">Android Fingerprint Framework (2)</a></li>
			
			<li><a href="/android/fingerprint/2019/10/03/Fingerprint-frmk1.html">Android Fingerprint Framework (1)</a></li>
			
		</ul>
	  </div>
	  
	
  <!-- Page navigation start here! -->
   <h1 id="posts-label">further reading</h1>
  
  <div class = "separator"></div>
  <div class="navigation-meta"><div class="navigation-bar">
	 
	 <a href="/android/fingerprint/2019/12/21/Fingerprint-frmk3.html"><span>Previous Post</span><br>Android Fingerprint Framework (3)</a>
	 
    </div><div class="navigation-bar"> 
	 
     <a href="/blog/github/2020/04/01/Blog-travisci.html"><span>Next Post</span><br>Use Travis CI to build and deploy project automatically on Github</a>
	 
    </div></div><br>
  <!-- comment box starts here! -->
    <!-- disqus start  --><!-- Gitalk start  -->
  <!-- Link Gitalk support file  -->
  <section class="gitalk">
  <div id="gitalk_thread"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script type="text/javascript" src="/assets/js/md5.min.js"></script>
  <div id="gitalk-container"></div>
  <script type="text/javascript">
   var gitalk = new Gitalk({
   // gitalk parameters
   clientID: '5e24fc307693a6df3bc5',
   clientSecret: '28c9c17e1174c705c42e9bdc92f87cadcc4ec8b8',
   repo: 'gangdong.github.io',
   owner: 'gangdong',
   admin: ['gangdong'],
   id: md5(location.pathname),
   title: 'comments'
    });
   gitalk.render('gitalk-container');
  </script>
  </section>
  <!-- Gitalk end -->
  <br/><br/><br/><div class = "footer">© 2012-2021 David Dong. All rights reserved.</div>
  
  <br>
</div>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script async type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-604f502a8198c9c9&domready=1"></script>


<!-- sidebar button, toggle display/hide sidebar -->
<script type="text/javascript">
        $('.btn').on('click',function(){
            $('.btn').toggleClass('btnc');
            $('.sidebar-container').toggleClass('sidebar-container-hide');
        })
</script>

      </section>
    </main><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MXGF3F8QN"></script>
      <script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-3MXGF3F8QN');
	</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body>
</html>
