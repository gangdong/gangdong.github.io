I"áP<p>ä¸Šä¸€ç¯‡åšæ–‡ <a href="/c/touch/linux/2014/06/25/Touch-driver.html">ã€ŒATMEL maXTouch ICé©±åŠ¨ä»£ç åˆ†æã€</a> æˆ‘ä»¬è®²åˆ°äº† Touch é©±åŠ¨ä»£ç å¦‚ä½•è¯»å–ICå†…éƒ¨è·å–åˆ°çš„è§¦æ‘¸äº‹ä»¶ä¿¡æ¯å¹¶é€šè¿‡<code class="language-plaintext highlighter-rouge">input_report_abs()</code>å’Œ<code class="language-plaintext highlighter-rouge">input_sync()</code>å‡½æ•°ä¸ŠæŠ¥ç»™ Linux çš„ Input å­ç³»ç»Ÿçš„è¿‡ç¨‹ã€‚ä»Šå¤©è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±èµ°è¿› Input å­ç³»ç»Ÿå†…éƒ¨æ¥çœ‹ä¸€ä¸‹äº‹ä»¶æ˜¯å¦‚ä½•è¢«ä¼ é€’åˆ° Android çš„ç”¨æˆ·ç©ºé—´çš„ã€‚</p>

<p>å†…å®¹å¦‚ä¸‹ã€‚</p>

<div class="separator"></div>
<h2 id="ç›®å½•">ç›®å½•</h2>
<ol>
  <li><a href="#1">Input å­ç³»ç»Ÿæ¡†æ¶</a></li>
  <li><a href="#2">æ³¨å†Œ Input è®¾å¤‡</a></li>
  <li><a href="#3">æ•°æ®ä¸ŠæŠ¥è¿‡ç¨‹</a>
    <ul>
      <li><a href="#3.1">3.1 input_handler</a></li>
      <li><a href="#3.2">3.2 æ³¨å†Œ input_handler</a></li>
      <li><a href="#3.3">3.3 input_handle</a></li>
      <li><a href="#3.4">3.4 æ³¨å†Œ input_handle</a></li>
      <li><a href="#3.5">3.5 ç”±æ ¸å¿ƒå±‚ (<code class="language-plaintext highlighter-rouge">inputcore</code>) åˆ°äº‹ä»¶å¤„ç†å±‚ (<code class="language-plaintext highlighter-rouge">eventhandler</code>)</a></li>
      <li><a href="#3.6">3.6 ç”±äº‹ä»¶å¤„ç†å±‚ (<code class="language-plaintext highlighter-rouge">eventhandler</code>) åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆ<code class="language-plaintext highlighter-rouge">user space</code>)</a></li>
      <li><a href="#3.7">3.7 ç”¨æˆ·ç©ºé—´è¯»å–äº‹ä»¶</a></li>
    </ul>
  </li>
  <li><a href="#4">æ€»ç»“</a></li>
</ol>
<div class="separator"></div>

<h2 id="1-input-å­ç³»ç»Ÿæ¡†æ¶"><span id="1">1. Input å­ç³»ç»Ÿæ¡†æ¶</span></h2>
<p>é¦–å…ˆæˆ‘ä»¬ä» Input å­ç³»ç»Ÿä»‹ç»å¼€å§‹ã€‚Input å­ç³»ç»Ÿç”±é©±åŠ¨å±‚ã€è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚ï¼ˆInput Coreï¼‰å’Œäº‹ä»¶å¤„ç†å±‚ï¼ˆEvent Handlerï¼‰3éƒ¨åˆ†ç»„æˆã€‚ä¸€ä¸ªè¾“å…¥äº‹ä»¶ï¼Œå¦‚é¼ æ ‡ç§»åŠ¨ï¼Œè§¦æ‘¸äº‹ä»¶ç­‰é€šè¿‡é©±åŠ¨å±‚-&gt;ç³»ç»Ÿæ ¸å¿ƒå±‚-&gt;äº‹ä»¶å¤„ç†å±‚-&gt;ç”¨æˆ·ç©ºé—´çš„é¡ºåºåˆ°è¾¾ç”¨æˆ·ç©ºé—´å¹¶ä¼ ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚å…¶ä¸­Input Coreå³è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒå±‚ç”± <code class="language-plaintext highlighter-rouge">driver/input/input.c</code> åŠç›¸å…³å¤´æ–‡ä»¶å®ç°ã€‚å…¶å¯¹ä¸‹æä¾›äº†è®¾å¤‡é©±åŠ¨çš„æ¥å£ï¼Œå¯¹ä¸Šæä¾›äº†äº‹ä»¶å¤„ç†å±‚çš„ç¼–ç¨‹æ¥å£ã€‚è¾“å…¥å­ç³»ç»Ÿä¸»è¦è®¾è®¡<code class="language-plaintext highlighter-rouge">input_dev</code>ã€<code class="language-plaintext highlighter-rouge">input_handler</code>ã€<code class="language-plaintext highlighter-rouge">input_handle</code>ç­‰æ•°æ®ç»“æ„ï¼Œå®ƒä»¬çš„ç”¨é€”å’ŒåŠŸèƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ <br />
<img src="/assets/image/touch-touchevent-01.png" alt="touchevent framework" /></p>

<h2 id="2-æ³¨å†Œ-input-è®¾å¤‡"><span id="2">2. æ³¨å†Œ Input è®¾å¤‡</span></h2>
<p>æˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»é©±åŠ¨ä»£ç çš„æ—¶å€™è®²åˆ°è¿‡ï¼Œè¾“å…¥è®¾å¤‡åœ¨åˆå§‹åŒ–çš„æ—¶å€™éƒ½éœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">input_allocate_device()</code>å’Œ<code class="language-plaintext highlighter-rouge">input_register_device()</code>è¿›è¡Œæ³¨å†Œã€‚å…¶ä¸­<code class="language-plaintext highlighter-rouge">input_allocate_device()</code>å‡½æ•°åœ¨å†…å­˜ä¸­ä¸ºè¾“å…¥è®¾å¤‡ç»“æ„ä½“åˆ†é…ä¸€ä¸ªç©ºé—´ï¼Œå¹¶å¯¹å…¶ä¸»è¦çš„æˆå‘˜è¿›è¡Œäº†åˆå§‹åŒ–ã€‚å®ƒçš„ä»£ç å¦‚ä¸‹ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="nf">input_allocate_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
 <span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="cm">/*åˆ†é…ä¸€ä¸ªinput_devç»“æ„ä½“ï¼Œå¹¶åˆå§‹åŒ–ä¸º0*/</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
 	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_dev_type</span><span class="p">;</span> 	<span class="cm">/*åˆå§‹åŒ–è®¾å¤‡çš„ç±»å‹*/</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_class</span><span class="p">;</span> 		<span class="cm">/*è®¾ç½®ä¸ºè¾“å…¥è®¾å¤‡ç±»*/</span>
 	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span> 		<span class="cm">/*åˆå§‹åŒ–deviceç»“æ„*/</span>
 	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span> 			<span class="cm">/*åˆå§‹åŒ–äº’æ–¥é”*/</span>
 	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span> 	<span class="cm">/*åˆå§‹åŒ–äº‹ä»¶è‡ªæ—‹é”*/</span>
 	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">h_list</span><span class="p">);</span> 		<span class="cm">/*åˆå§‹åŒ–é“¾è¡¨*/</span>
 	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span> 		<span class="cm">/*åˆå§‹åŒ–é“¾è¡¨*/</span>
 	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span> 			<span class="cm">/*æ¨¡å—å¼•ç”¨åŠ 1*/</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">input_dev</code>ç±»å‹çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“æ˜¯ä¸€ä¸ªè¾“å…¥è®¾å¤‡ç»“æ„ä½“ï¼ŒåŒ…å«äº†è¾“å…¥è®¾å¤‡çš„ä¸€äº›ç›¸å…³ä¿¡æ¯ï¼Œå¦‚è®¾å¤‡æ”¯æŒçš„æŒ‰é”®ç ã€è®¾å¤‡çš„åç§°ã€è®¾å¤‡æ”¯æŒçš„äº‹ä»¶ç­‰ã€‚</p>

<p>æ¥ä¸‹æ¥è°ƒç”¨çš„<code class="language-plaintext highlighter-rouge">input_register_device()</code>å‡½æ•°å¾ˆé‡è¦ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">input_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">input_no</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_SYN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">input_repeat_key</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">getkeycode</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">getkeycode</span> <span class="o">=</span> <span class="n">input_default_getkeycode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">setkeycode</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">setkeycode</span> <span class="o">=</span> <span class="n">input_default_setkeycode</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"input%ld"</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_no</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">kobject_get_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"input: %s as %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">"Unspecified device"</span><span class="p">,</span> <span class="n">path</span> <span class="o">?</span> <span class="n">path</span> <span class="o">:</span> <span class="s">"NA"</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev_list</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_handler_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
	<span class="n">input_attach_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
	<span class="n">input_wakeup_procfs_readers</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">input_register_device()</code>å‡½æ•°æ˜¯è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒï¼ˆinput coreï¼‰æä¾›çš„å‡½æ•°ã€‚è¯¥å‡½æ•°å°†<code class="language-plaintext highlighter-rouge">input_dev</code>ç»“æ„ä½“æ³¨å†Œåˆ°è¾“å…¥å­ç³»ç»Ÿæ ¸å¿ƒä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">input_dev</code>ç»“æ„ä½“å¿…é¡»ç”±å‰é¢è®²çš„ <code class="language-plaintext highlighter-rouge">input_allocate_device()</code>å‡½æ•°æ¥åˆ†é…ã€‚<code class="language-plaintext highlighter-rouge">input_register_device()</code>å‡½æ•°å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå¿…é¡»è°ƒç”¨ <code class="language-plaintext highlighter-rouge">input_free_device()</code> å‡½æ•°é‡Šæ”¾åˆ†é…çš„ç©ºé—´ã€‚å¦‚æœè¯¥å‡½æ•°æ³¨å†ŒæˆåŠŸï¼Œåœ¨å¸è½½å‡½æ•°ä¸­åº”è¯¥è°ƒç”¨ <code class="language-plaintext highlighter-rouge">input_unregister_device()</code> å‡½æ•°æ¥æ³¨é”€è¾“å…¥è®¾å¤‡ç»“æ„ä½“ã€‚ <br />
<code class="language-plaintext highlighter-rouge">input_register_device()</code>å‡½æ•°ä¸»è¦å®Œæˆäº†å¦‚ä¸‹çš„å·¥ä½œï¼š</p>
<ul>
  <li>å‡½æ•°ä¸­è°ƒç”¨<code class="language-plaintext highlighter-rouge">__set_bit()</code>å‡½æ•°è®¾ç½®<code class="language-plaintext highlighter-rouge">input_dev</code>æ‰€æ”¯æŒçš„äº‹ä»¶ç±»å‹ã€‚äº‹ä»¶ç±»å‹ç”±<code class="language-plaintext highlighter-rouge">input_dev</code>çš„<code class="language-plaintext highlighter-rouge">evbit</code>æˆå‘˜æ¥è¡¨ç¤ºï¼Œåœ¨è¿™é‡Œå°†å…¶<code class="language-plaintext highlighter-rouge">EV_SYN</code>ç½®ä½ï¼Œè¡¨ç¤ºè®¾å¤‡æ”¯æŒæ‰€æœ‰çš„äº‹ä»¶ã€‚æ³¨æ„ï¼Œä¸€ä¸ªè®¾å¤‡å¯ä»¥æ”¯æŒä¸€ç§æˆ–è€…å¤šç§äº‹ä»¶ç±»å‹ã€‚å¸¸ç”¨çš„äº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š</li>
</ul>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">#define EV_SYN 0x00 /*è¡¨ç¤ºè®¾å¤‡æ”¯æŒæ‰€æœ‰çš„äº‹ä»¶*/
#define EV_KEY 0x01 /*é”®ç›˜æˆ–è€…æŒ‰é”®ï¼Œè¡¨ç¤ºä¸€ä¸ªé”®ç */
#define EV_REL 0x02 /*é¼ æ ‡è®¾å¤‡ï¼Œè¡¨ç¤ºä¸€ä¸ªç›¸å¯¹çš„å…‰æ ‡ä½ç½®ç»“æœ*/
#define EV_ABS 0x03 /*æ‰‹å†™æ¿äº§ç”Ÿçš„å€¼ï¼Œå…¶æ˜¯ä¸€ä¸ªç»å¯¹æ•´æ•°å€¼*/
#define EV_MSC 0x04 /*å…¶ä»–ç±»å‹*/
#define EV_LED 0x11 /*LEDç¯è®¾å¤‡*/
#define EV_SND 0x12 /*èœ‚é¸£å™¨ï¼Œè¾“å…¥å£°éŸ³*/
#define EV_REP 0x14 /*å…è®¸é‡å¤æŒ‰é”®ç±»å‹*/
#define EV_PWR 0x16 /*ç”µæºç®¡ç†äº‹ä»¶*/</code></pre></figure>

<ul>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">dev_set_name()</code>è®¾ç½®<code class="language-plaintext highlighter-rouge">input_dev</code>ä¸­çš„deviceçš„åå­—ï¼Œåå­—ä»¥<code class="language-plaintext highlighter-rouge">input0</code>ã€<code class="language-plaintext highlighter-rouge">input1</code>ã€<code class="language-plaintext highlighter-rouge">input2</code>ã€<code class="language-plaintext highlighter-rouge">input3</code>ã€<code class="language-plaintext highlighter-rouge">input4</code>ç­‰çš„å½¢å¼å‡ºç°åœ¨sysfsæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</li>
  <li>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">device_add()</code>å‡½æ•°å°†<code class="language-plaintext highlighter-rouge">input_dev</code>åŒ…å«çš„deviceç»“æ„æ³¨å†Œåˆ°Linuxè®¾å¤‡æ¨¡å‹ä¸­ï¼Œå¹¶å¯ä»¥åœ¨sysfsæ–‡ä»¶ç³»ç»Ÿä¸­è¡¨ç°å‡ºæ¥ã€‚</li>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">list_add_tail()</code>å‡½æ•°å°†<code class="language-plaintext highlighter-rouge">input_dev</code>åŠ å…¥<code class="language-plaintext highlighter-rouge">input_dev_list</code>é“¾è¡¨ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">input_dev_list</code>é“¾è¡¨ä¸­åŒ…å«äº†ç³»ç»Ÿä¸­æ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">input_dev</code>è®¾å¤‡ã€‚</li>
  <li>è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">input_attach_handler()</code>å‡½æ•°ï¼Œ
<code class="language-plaintext highlighter-rouge">input_attach_handler()</code>å‡½æ•°ç”¨æ¥åŒ¹é…<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">input_handler</code>ï¼Œåªæœ‰åŒ¹é…æˆåŠŸï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥çš„å…³è”æ“ä½œã€‚<br />      <code class="language-plaintext highlighter-rouge">input_attach_handler()</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">input_attach_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span> <span class="cm">/*è¾“å…¥è®¾å¤‡çš„æŒ‡é’ˆ*/</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">blacklist</span> <span class="o">&amp;&amp;</span> <span class="n">input_match_device</span><span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">blacklist</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/*è®¾å¤‡å’Œå¤„ç†å‡½æ•°ä¹‹é—´çš„åŒ¹é…*/</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">input_match_device</span><span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span><span class="cm">/*è¿æ¥è®¾å¤‡å’Œå¤„ç†å‡½æ•°*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">"input: failed to attach handler %s to device %s,"</span><span class="n">error</span><span class="o">:</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="s">",</span><span class="err">
</span><span class="s">			handler-&gt;name, kobject_name(&amp;dev-&gt;dev.kobj), error);</span><span class="err">
</span><span class="s">	return error;</span><span class="err">
</span><span class="s">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">input_attach_handler()</code>ä¸»è¦å®Œæˆçš„å·¥ä½œæœ‰ï¼š</p>
<ul>
  <li>é¦–å…ˆåˆ¤æ–­<code class="language-plaintext highlighter-rouge">handle</code>çš„<code class="language-plaintext highlighter-rouge">blacklist</code>æ˜¯å¦è¢«èµ‹å€¼ï¼Œå¦‚æœè¢«èµ‹å€¼ï¼Œåˆ™åŒ¹é…<code class="language-plaintext highlighter-rouge">blacklist</code>ä¸­çš„æ•°æ®è·Ÿ<code class="language-plaintext highlighter-rouge">dev-&gt;id</code>çš„æ•°æ®æ˜¯å¦åŒ¹é…ã€‚<code class="language-plaintext highlighter-rouge">blacklist</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">input_device_id*</code>çš„ç±»å‹ï¼Œå…¶æŒ‡å‘<code class="language-plaintext highlighter-rouge">input_device_ids</code>çš„ä¸€ä¸ªè¡¨ï¼Œè¿™ä¸ªè¡¨ä¸­å­˜æ”¾äº†é©±åŠ¨ç¨‹åºåº”è¯¥å¿½ç•¥çš„è®¾å¤‡ã€‚å³ä½¿åœ¨<code class="language-plaintext highlighter-rouge">id_table</code>ä¸­æ‰¾åˆ°æ”¯æŒçš„é¡¹ï¼Œä¹Ÿåº”è¯¥å¿½ç•¥è¿™ç§è®¾å¤‡ã€‚</li>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">input_match_device()</code>å‡½æ•°åŒ¹é…<code class="language-plaintext highlighter-rouge">handle-&gt;id_table</code>å’Œ<code class="language-plaintext highlighter-rouge">dev-&gt;id</code>ä¸­çš„æ•°æ®ã€‚å¦‚æœä¸æˆåŠŸåˆ™è¿”å›ã€‚<code class="language-plaintext highlighter-rouge">handle-&gt;id_table</code>ä¹Ÿæ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">input_device_id</code>ç±»å‹çš„æŒ‡é’ˆï¼Œå…¶è¡¨ç¤ºé©±åŠ¨æ”¯æŒçš„è®¾å¤‡åˆ—è¡¨ã€‚</li>
  <li>å¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™è°ƒç”¨<code class="language-plaintext highlighter-rouge">handler-&gt;connect()</code>å‡½æ•°å°†<code class="language-plaintext highlighter-rouge">handler</code>ä¸<code class="language-plaintext highlighter-rouge">input_dev</code>è¿æ¥èµ·æ¥ã€‚ <br />
<code class="language-plaintext highlighter-rouge">input_match_device()</code>å‡½æ•° <br />
<code class="language-plaintext highlighter-rouge">input_match_device()</code>å‡½æ•°ç”¨æ¥ä¸<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">handler</code>è¿›è¡ŒåŒ¹é…ã€‚<code class="language-plaintext highlighter-rouge">handler</code>çš„<code class="language-plaintext highlighter-rouge">id_table</code>è¡¨ä¸­å®šä¹‰äº†å…¶æ”¯æŒçš„<code class="language-plaintext highlighter-rouge">input_dev</code>è®¾å¤‡ã€‚<br />
è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="nf">input_match_device</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span>
<span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_BUS</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_VENDOR</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_PRODUCT</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_DEVICE_ID_MATCH_VERSION</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">evbit</span><span class="p">,</span> <span class="n">EV_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">keybit</span><span class="p">,</span> <span class="n">KEY_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">relbit</span><span class="p">,</span> <span class="n">REL_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">absbit</span><span class="p">,</span> <span class="n">ABS_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">mscbit</span><span class="p">,</span> <span class="n">MSC_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">ledbit</span><span class="p">,</span> <span class="n">LED_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">sndbit</span><span class="p">,</span> <span class="n">SND_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">ffbit</span><span class="p">,</span> <span class="n">FF_MAX</span><span class="p">);</span>
		<span class="n">MATCH_BIT</span><span class="p">(</span><span class="n">swbit</span><span class="p">,</span> <span class="n">SW_MAX</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">input_match_device()</code>ä¸»è¦å®Œæˆçš„å·¥ä½œæœ‰ï¼š</p>
<ul>
  <li>åŒ¹é…è®¾å¤‡çš„äº§å“æ€»çº¿ç±»å‹/vendor/ç‰ˆæœ¬ä¿¡æ¯ã€‚</li>
  <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">id-&gt;flags</code>å®šä¹‰çš„ç±»å‹åŒ¹é…æˆåŠŸï¼Œæˆ–è€…<code class="language-plaintext highlighter-rouge">id-&gt;flags</code>æ²¡æœ‰å®šä¹‰ï¼Œæ‰ä¼šè¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">MATCH_BIT</code>çš„åŒ¹é…é¡¹ã€‚
<code class="language-plaintext highlighter-rouge">MATCH_BIT</code>å®çš„å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">#define MATCH_BIT(bit, max) \
for (i = 0; i &lt; BITS_TO_LONGS(max); i++) \
if ((id-&gt;bit[i] &amp; dev-&gt;bit[i]) != id-&gt;bit[i]) \
break; \
if (i != BITS_TO_LONGS(max)) \
continue;</code></pre></figure>

<p>ä»<code class="language-plaintext highlighter-rouge">MATCH_BIT</code>å®çš„å®šä¹‰å¯ä»¥çœ‹å‡ºã€‚åªæœ‰å½“<code class="language-plaintext highlighter-rouge">iput device</code>å’Œ<code class="language-plaintext highlighter-rouge">input handler</code>çš„IDæˆå‘˜åœ¨evbitã€keybitã€â€¦ swbité¡¹ç›¸åŒæ‰ä¼šåŒ¹é…æˆåŠŸã€‚</p>

<h2 id="3-æ•°æ®ä¸ŠæŠ¥è¿‡ç¨‹"><span id="3">3. æ•°æ®ä¸ŠæŠ¥è¿‡ç¨‹</span></h2>
<p>Input å­ç³»ç»Ÿå„å±‚ä¹‹é—´é€šä¿¡çš„åŸºæœ¬å•ä½å°±æ˜¯äº‹ä»¶ï¼Œä»»ä½•ä¸€ä¸ªè¾“å…¥è®¾å¤‡çš„åŠ¨ä½œéƒ½å¯ä»¥æŠ½åƒæˆä¸€ç§äº‹ä»¶ï¼Œå¦‚é”®ç›˜çš„æŒ‰ä¸‹ï¼Œè§¦æ‘¸å±çš„æŒ‰ä¸‹ï¼Œé¼ æ ‡çš„ç§»åŠ¨ç­‰ã€‚äº‹ä»¶æœ‰ä¸‰ç§å±æ€§ï¼šç±»å‹ï¼ˆtypeï¼‰ï¼Œç¼–ç (code)ï¼Œå€¼(value)ï¼ŒInputå­ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰äº‹ä»¶éƒ½å®šä¹‰åœ¨<code class="language-plaintext highlighter-rouge">input.h</code>ä¸­ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„ç±»å‹ï¼Œæ‰€å±ç±»å‹æ”¯æŒçš„ç¼–ç ç­‰ã€‚äº‹ä»¶ä¼ é€çš„æ–¹å‘æ˜¯ç¡¬ä»¶é©±åŠ¨å±‚â€“&gt;å­ç³»ç»Ÿæ ¸å¿ƒâ€“&gt;äº‹ä»¶å¤„ç†å±‚â€“&gt;ç”¨æˆ·ç©ºé—´ã€‚</p>

<p>åœ¨é©±åŠ¨ä»£ç çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°é©±åŠ¨æœ€ç»ˆè°ƒç”¨åˆ°<code class="language-plaintext highlighter-rouge">input_report_abs()</code>å°†toucheventæ‰“åŒ…å‘é€ç»™Inputå­ç³»ç»Ÿã€‚
<code class="language-plaintext highlighter-rouge">input_report_abs()</code>å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">input_report_abs</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_ABS</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>å¯ä»¥çœ‹åˆ°å…¶ä¸ºå†…è”å‡½æ•°, ä¸º<code class="language-plaintext highlighter-rouge">input_event(,EV_ABS, ...)</code>çš„äºŒæ¬¡å°è£…ã€‚</p>

<p><img src="/assets/image/touch-touchevent-02.png" alt="touchevent framework" /></p>

<p><code class="language-plaintext highlighter-rouge">input_event()</code>çš„ä»£ç å¦‚ä¸‹,ç•¥è¿‡æ— å…³çš„éƒ¨åˆ†ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">input_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">....</span><span class="c1">//eventæ˜¯å¦æ”¯æŒ, è¿™ä¸ªå’Œé©±åŠ¨é‡Œprobe()æ—¶å¡«å……èƒ½åŠ›,è®¾ç½®å‚æ•°æœ‰å…³,ç•¥è¿‡</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_event_supported</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">,</span> <span class="n">EV_MAX</span><span class="p">))</span> <span class="p">{</span>
	<span class="p">....</span>
        <span class="n">input_handle_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">...</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">input_event()</code> è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">input_handle_event()</code>å‡½æ•°ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">input_handle_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">disposition</span> <span class="o">=</span> <span class="n">input_get_disposition</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span> <span class="c1">//å¾—åˆ°disposition</span>
<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">disposition</span> <span class="o">&amp;</span> <span class="n">INPUT_FLUSH</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">input_pass_values</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vals</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span><span class="p">);</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_vals</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vals</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_value_sync</span><span class="p">;</span>
        <span class="n">input_pass_values</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vals</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span><span class="p">);</span>  <span class="c1">//**&lt;--&gt; é‡ç‚¹,</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸‹<code class="language-plaintext highlighter-rouge">input_handle_event()</code> â€“&gt; <code class="language-plaintext highlighter-rouge">input_get_disposition()</code> EV_SYNäº‹ä»¶å’ŒEV_ABSçš„è¿”å›å€¼ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">input_get_disposition</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pval</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">disposition</span> <span class="o">=</span> <span class="n">INPUT_IGNORE_EVENT</span><span class="p">;</span>
	<span class="p">......</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">EV_SYN</span><span class="p">:</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SYN_CONFIG</span><span class="p">:</span>
            <span class="n">disposition</span> <span class="o">=</span> <span class="n">INPUT_PASS_TO_ALL</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">SYN_REPORT</span><span class="p">:</span>
            <span class="n">disposition</span> <span class="o">=</span> <span class="n">INPUT_PASS_TO_HANDLERS</span> <span class="o">|</span> <span class="n">INPUT_FLUSH</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">SYN_MT_REPORT</span><span class="p">:</span>
            <span class="n">disposition</span> <span class="o">=</span> <span class="n">INPUT_PASS_TO_HANDLERS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
	<span class="p">......</span>
    <span class="k">case</span> <span class="n">EV_ABS</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_event_supported</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">,</span> <span class="n">ABS_MAX</span><span class="p">))</span>
            <span class="n">disposition</span> <span class="o">=</span> <span class="n">input_handle_abs_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span><span class="c1">//è¿™ä¸ªå¯ä»¥çœ‹çœ‹,ä»–ä¼šå¯¹ç›¸åŒå€¼è¿›è¡Œè¿‡æ»¤,è¿”å›INPUT_IGNORE_EVENT</span>

        <span class="k">break</span><span class="p">;</span>
	<span class="p">......</span>
    <span class="k">return</span> <span class="n">disposition</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>è®©æˆ‘ä»¬å›åˆ°<code class="language-plaintext highlighter-rouge">input_handle_event()</code> â€“&gt; <code class="language-plaintext highlighter-rouge">input_pass_values()</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">input_pass_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">input_to_handler</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">h_list</span><span class="p">,</span> <span class="n">d_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">input_to_handler</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
	<span class="p">......</span>
<span class="p">}</span></code></pre></figure>

<p>å…¶é‡ç‚¹å‡½æ•°ä¸º<code class="language-plaintext highlighter-rouge">input_to_handler()</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">input_to_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
            <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">;</span>
	<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">vals</span><span class="p">;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="n">v</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span>
                <span class="k">continue</span><span class="p">;</span>
	<span class="p">.......</span>
    <span class="p">}</span>
	<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span> <span class="c1">//&lt;--handlerçš„events.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">vals</span><span class="p">;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="n">v</span><span class="o">++</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>è¿™é‡Œé¢<code class="language-plaintext highlighter-rouge">input_handle</code>ç»“æ„ä½“ä»£è¡¨ä¸€ä¸ªæˆåŠŸé…å¯¹çš„<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">input_handler</code>ã€‚<br /> <br />
å…³äº<code class="language-plaintext highlighter-rouge">input_handle</code>ï¼Œ<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">input_handler</code>ç»“æ„ä½“çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">struct input_dev</code>ï¼š ç‰©ç†è¾“å…¥è®¾å¤‡çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼ŒåŒ…å«è®¾å¤‡ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">struct input_handler</code>ï¼š äº‹ä»¶å¤„ç†ç»“æ„ä½“ï¼Œå®šä¹‰æ€ä¹ˆå¤„ç†äº‹ä»¶çš„é€»è¾‘ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">struct input_handle</code>ï¼š ç”¨æ¥åˆ›å»ºinput_devå’Œinput_handlerä¹‹é—´å…³ç³»çš„ç»“æ„ä½“ã€‚</li>
</ul>

<h3 id="31-input_handler"><span id="3.1">3.1 input_handler</span></h3>
<p><code class="language-plaintext highlighter-rouge">input_handler</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">input_handler</span> <span class="p">{</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">events</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
               <span class="k">const</span> <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
    <span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">filter</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">connect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">disconnect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
<span class="p">......</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

    <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id_table</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">list_head</span>    <span class="n">h_list</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span>    <span class="n">node</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<p>è¯¥ç»“æ„ä½“ä¸»è¦æ˜¯</p>
<ul>
  <li>å®šä¹‰äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">event()</code>å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†è¢«è¾“å…¥å­ç³»ç»Ÿè°ƒç”¨å»å¤„ç†å‘é€ç»™è®¾å¤‡çš„äº‹ä»¶ã€‚ä¾‹å¦‚å°†å‘é€ä¸€ä¸ªäº‹ä»¶å‘½ä»¤LEDç¯ç‚¹äº®ï¼Œå®é™…æ§åˆ¶ç¡¬ä»¶çš„ç‚¹äº®æ“ä½œå°±å¯ä»¥æ”¾åœ¨<code class="language-plaintext highlighter-rouge">event()</code>å‡½æ•°ä¸­å®ç°ã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">connect()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨æ¥è¿æ¥<code class="language-plaintext highlighter-rouge">handler</code>å’Œ<code class="language-plaintext highlighter-rouge">input_dev</code>ã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">disconnect()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥æ–­å¼€<code class="language-plaintext highlighter-rouge">handler</code>å’Œ<code class="language-plaintext highlighter-rouge">input_dev</code>ä¹‹é—´çš„è”ç³»ã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ªnameï¼Œè¡¨ç¤ºhandlerçš„åå­—ï¼Œæ˜¾ç¤ºåœ¨<code class="language-plaintext highlighter-rouge">/proc/bus/input/handlers</code>ç›®å½•ä¸­ã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">id_table</code>è¡¨ï¼Œè¡¨ç¤ºé©±åŠ¨èƒ½å¤Ÿå¤„ç†çš„è¡¨ã€‚</li>
  <li>æŒ‡å‘ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">input_device_id</code>è¡¨ï¼Œè¿™ä¸ªè¡¨åŒ…å«handleråº”è¯¥å¿½ç•¥çš„è®¾å¤‡ã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ªé“¾è¡¨h_listï¼Œè¡¨ç¤ºä¸è¿™ä¸ª<code class="language-plaintext highlighter-rouge">input_handler</code>ç›¸è”ç³»çš„ä¸‹ä¸€ä¸ªhandlerã€‚</li>
  <li>å®šä¹‰äº†ä¸€ä¸ªé“¾è¡¨nodeï¼Œå°†å…¶è¿æ¥åˆ°å…¨å±€çš„<code class="language-plaintext highlighter-rouge">input_handler_list</code>é“¾è¡¨ä¸­ï¼Œæ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">input_handler</code>éƒ½è¿æ¥åœ¨å…¶ä¸Šã€‚</li>
</ul>

<h3 id="32-æ³¨å†Œ-input_handler"><span id="3.2">3.2 æ³¨å†Œ input_handler</span></h3>
<p><code class="language-plaintext highlighter-rouge">input_register_handler()</code>å‡½æ•°æ³¨å†Œä¸€ä¸ªæ–°çš„<code class="language-plaintext highlighter-rouge">input handler</code>å¤„ç†å™¨ã€‚è¿™ä¸ªhandlerå°†ä¸ºè¾“å…¥è®¾å¤‡ä½¿ç”¨ï¼Œä¸€ä¸ªhandlerå¯ä»¥æ·»åŠ åˆ°å¤šä¸ªæ”¯æŒå®ƒçš„è®¾å¤‡ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªhandlerå¯ä»¥å¤„ç†å¤šä¸ªè¾“å…¥è®¾å¤‡çš„äº‹ä»¶ã€‚å‡½æ•°çš„å‚æ•°ä¼ å…¥ç®€è¦æ³¨å†Œçš„<code class="language-plaintext highlighter-rouge">input_handler</code>æŒ‡é’ˆï¼Œè¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">input_register_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span><span class="c1">//åˆå§‹åŒ–h_list</span>
    <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">h_list</span><span class="p">);</span>
    <span class="c1">//å°†nodeåŠ åˆ°listå°¾éƒ¨</span>
    <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_handler_list</span><span class="p">);</span>
    <span class="c1">//åœ¨æ³¨å†Œhandlerçš„æ—¶å€™ä¹Ÿå¯¹å·²æœ‰è®¾å¤‡è°ƒç”¨ä¸€æ¬¡attach()</span>
    <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">input_attach_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
<span class="p">......</span>
<span class="p">}</span></code></pre></figure>

<p>å®Œæˆçš„ä¸»è¦å·¥ä½œï¼š</p>
<ul>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">list_add_tail()</code>å‡½æ•°ï¼Œå°†handleråŠ å…¥å…¨å±€çš„<code class="language-plaintext highlighter-rouge">input_handler_list</code>é“¾è¡¨ä¸­ï¼Œè¯¥é“¾è¡¨åŒ…å«äº†ç³»ç»Ÿä¸­æ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">input_handler</code>ã€‚</li>
  <li>è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">input_attach_handler()</code>å‡½æ•°ã€‚<code class="language-plaintext highlighter-rouge">input_attach_handler()</code>å‡½æ•°çš„ä½œç”¨æ˜¯åŒ¹é… <code class="language-plaintext highlighter-rouge">input_dev_list</code>é“¾è¡¨ä¸­çš„<code class="language-plaintext highlighter-rouge">input_dev</code>ä¸handlerã€‚å¦‚æœæˆåŠŸä¼šå°†<code class="language-plaintext highlighter-rouge">input_dev</code>ä¸handlerè”ç³»èµ·æ¥ã€‚</li>
</ul>

<h3 id="33-input_handle"><span id="3.3">3.3 input_handle</span></h3>
<p><code class="language-plaintext highlighter-rouge">Input_Handle</code> ç»“æ„ä½“ <br />
<code class="language-plaintext highlighter-rouge">input_register_handle()</code>å‡½æ•°ç”¨æ¥æ³¨å†Œä¸€ä¸ªæ–°çš„handleåˆ°è¾“å…¥å­ç³»ç»Ÿä¸­ã€‚<code class="language-plaintext highlighter-rouge">input_handle</code>çš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥è¿æ¥<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">input_handler</code>ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">input_handle</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">d_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">h_node</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<h3 id="34-æ³¨å†Œ-input_handle"><span id="3.4">3.4 æ³¨å†Œ input_handle</span></h3>
<p><code class="language-plaintext highlighter-rouge">input_handle</code>æ˜¯ç”¨æ¥è¿æ¥<code class="language-plaintext highlighter-rouge">input_dev</code>å’Œ<code class="language-plaintext highlighter-rouge">input_handler</code>çš„ä¸€ä¸ªä¸­é—´ç»“æ„ä½“ã€‚äº‹ä»¶é€šè¿‡<code class="language-plaintext highlighter-rouge">input_handle</code>ä» <code class="language-plaintext highlighter-rouge">input_dev</code> å‘é€åˆ°<code class="language-plaintext highlighter-rouge">input_handler</code>ï¼Œæˆ–è€…ä»<code class="language-plaintext highlighter-rouge">input_handler</code>å‘é€åˆ°<code class="language-plaintext highlighter-rouge">input_dev</code>è¿›è¡Œå¤„ç†ã€‚åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">input_handle</code>ä¹‹å‰ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œå‡½æ•°æ˜¯<code class="language-plaintext highlighter-rouge">input_register_handle()</code>ã€‚
<code class="language-plaintext highlighter-rouge">input_register_handle()</code>å‡½æ•°ç”¨æ¥æ³¨å†Œä¸€ä¸ªæ–°çš„handleåˆ°è¾“å…¥å­ç³»ç»Ÿä¸­ã€‚è¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">input_handle</code>ç±»å‹çš„æŒ‡é’ˆï¼Œè¯¥å˜é‡è¦åœ¨æ³¨å†Œå‰å¯¹å…¶æˆå‘˜åˆå§‹åŒ–ã€‚<br />
<code class="language-plaintext highlighter-rouge">input_register_handle()</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">input_register_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handlehandler</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">d_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">h_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">h_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">h_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">handler</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<ul>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">list_add_tail_rcu()</code>å‡½æ•°å°†handleåŠ å…¥è¾“å…¥è®¾å¤‡çš„<code class="language-plaintext highlighter-rouge">dev-&gt;h_list</code>é“¾è¡¨ä¸­ã€‚</li>
  <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">list_add_tail()</code>å‡½æ•°å°†handleåŠ å…¥input_handlerçš„<code class="language-plaintext highlighter-rouge">handler-&gt;h_list</code>é“¾è¡¨ä¸­ã€‚</li>
</ul>

<p>input_devã€input_handlerå’Œhandleä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
  <li>input_dev æ˜¯ç¡¬ä»¶é©±åŠ¨å±‚ï¼Œä»£è¡¨ä¸€ä¸ªinputè®¾å¤‡ï¼›</li>
  <li>input_handler æ˜¯äº‹ä»¶å¤„ç†å±‚ï¼Œä»£è¡¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼›</li>
  <li>input_handle ä¸ªäººè®¤ä¸ºå±äºæ ¸å¿ƒå±‚ï¼Œä»£è¡¨ä¸€ä¸ªé…å¯¹çš„inputè®¾å¤‡ä¸inputäº‹ä»¶å¤„ç†å™¨ï¼›</li>
  <li>input_dev é€šè¿‡å…¨å±€çš„<code class="language-plaintext highlighter-rouge">input_dev_list</code>é“¾æ¥åœ¨ä¸€èµ·ã€‚è®¾å¤‡æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œï¼›</li>
  <li>input_handler é€šè¿‡å…¨å±€çš„<code class="language-plaintext highlighter-rouge">input_handler_list</code>é“¾æ¥åœ¨ä¸€èµ·ã€‚äº‹ä»¶å¤„ç†å™¨æ³¨å†Œçš„æ—¶å€™å®ç°è¿™ä¸ªæ“ä½œï¼ˆäº‹ä»¶å¤„ç†å™¨ä¸€èˆ¬å†…æ ¸è‡ªå¸¦ï¼Œä¸€èˆ¬ä¸éœ€è¦æˆ‘ä»¬æ¥å†™ï¼‰ï¼›</li>
  <li>input_hande æ²¡æœ‰ä¸€ä¸ªå…¨å±€çš„é“¾è¡¨ï¼Œå®ƒæ³¨å†Œçš„æ—¶å€™å°†è‡ªå·±åˆ†åˆ«æŒ‚åœ¨äº†input_dev å’Œinput_handler çš„h_listä¸Šäº†ã€‚é€šè¿‡input_dev å’Œinput_handlerå°±å¯ä»¥æ‰¾åˆ°input_handle åœ¨è®¾å¤‡æ³¨å†Œå’Œäº‹ä»¶å¤„ç†å™¨ï¼Œæ³¨å†Œçš„æ—¶å€™éƒ½è¦è¿›è¡Œé…å¯¹å·¥ä½œï¼Œé…å¯¹åå°±ä¼šå®ç°é“¾æ¥ã€‚é€šè¿‡input_handleä¹Ÿå¯ä»¥æ‰¾åˆ°input_devå’Œinput_handlerã€‚</li>
</ul>

<p><img src="/assets/image/touch-touchevent-03.png" alt="touchevent framework" /></p>

<h3 id="35-ç”±æ ¸å¿ƒå±‚-inputcore-åˆ°äº‹ä»¶å¤„ç†å±‚-eventhandler"><span id="3.5">3.5 ç”±æ ¸å¿ƒå±‚ (inputcore) åˆ°äº‹ä»¶å¤„ç†å±‚ (eventhandler)</span></h3>
<p>æˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„ä»£ç è°ƒç”¨åˆ°</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">handler</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span></code></pre></figure>

<p>è¿™é‡Œhandler-&gt;eventsåˆ™æ˜¯<code class="language-plaintext highlighter-rouge">Evdev.c(drivers\input)</code>é‡Œå®šä¹‰çš„ã€‚
events å‡½æ•°æ˜¯å½“äº‹ä»¶å¤„ç†å™¨æ¥æ”¶åˆ°äº†æ¥è‡ªinputè®¾å¤‡ä¼ æ¥çš„äº‹ä»¶æ—¶è°ƒç”¨çš„å¤„ç†å‡½æ•°ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">input_handler</span> <span class="n">evdev_handler</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">evdev_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">evdev_events</span><span class="p">,</span>
	<span class="p">...</span>
<span class="p">}</span></code></pre></figure>

<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å‡½æ•°åŸå‹ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">evdev_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
             <span class="k">const</span> <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">evdev_pass_values</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ev_time</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evdev</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">evdev_pass_values</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ev_time</span><span class="p">);</span>
<span class="p">......</span>
<span class="p">}</span></code></pre></figure>

<p>äº‹ä»¶å¤„ç†å±‚ï¼ˆeventhandlerï¼‰è´Ÿè´£å°†äº‹ä»¶ä¸ŠæŠ¥ï¼Œå°†é”®å€¼ã€åæ ‡ç­‰æ•°æ®ä¸ŠæŠ¥çš„å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">evdev_pass_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">evdev_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
            <span class="k">const</span> <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">vals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
            <span class="n">ktime_t</span> <span class="o">*</span><span class="n">ev_time</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">evdev</span> <span class="o">*</span><span class="n">evdev</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">evdev</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">input_value</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">input_event</span> <span class="n">event</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timespec64</span> <span class="n">ts</span><span class="p">;</span>
<span class="p">......</span><span class="c1">//æ—¶é—´</span>
    <span class="n">event</span><span class="p">.</span><span class="n">input_event_sec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
    <span class="n">event</span><span class="p">.</span><span class="n">input_event_usec</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="n">NSEC_PER_USEC</span><span class="p">;</span>
<span class="p">......</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">vals</span><span class="p">;</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="n">v</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="p">......</span><span class="c1">//äº‹ä»¶æ•°æ®å¡«å……</span>
        <span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
        <span class="n">event</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
        <span class="n">event</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
        <span class="n">__pass_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span> <span class="c1">//&lt;--æ”¾åˆ°client-&gt;bufferé‡Œ</span>
    <span class="p">}</span>
<span class="p">......</span>
<span class="p">}</span></code></pre></figure>

<h3 id="36-ç”±äº‹ä»¶å¤„ç†å±‚-eventhandler-åˆ°ç”¨æˆ·ç©ºé—´user-space"><span id="3.6">3.6 ç”±äº‹ä»¶å¤„ç†å±‚ (eventhandler) åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰</span></h3>

<p><code class="language-plaintext highlighter-rouge">__pass_event()</code>å°†eventæ”¾åˆ°client-&gt;buffer[]é‡Œ,ç”±buffer ä¼ å…¥ç”¨æˆ·ç©ºé—´ã€‚ <br />
<code class="language-plaintext highlighter-rouge">__pass_event()</code> å‡½æ•°æœ€ç»ˆå°†äº‹ä»¶ä¼ é€’ç»™äº†ç”¨æˆ·ç«¯çš„client ç»“æ„ä¸­çš„<code class="language-plaintext highlighter-rouge">input_event</code> æ•°ç»„ä¸­ï¼Œåªéœ€å°†è¿™ä¸ª<code class="language-plaintext highlighter-rouge">input_event</code>æ•°ç»„å¤åˆ¶ç»™ç”¨æˆ·ç©ºé—´ï¼Œè¿›ç¨‹å°±èƒ½æ”¶åˆ°è§¦æ‘¸å±æŒ‰ä¸‹çš„ä¿¡æ¯äº†ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__pass_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">evdev_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
             <span class="k">const</span> <span class="k">struct</span> <span class="n">input_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
    <span class="n">client</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&amp;=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/*
         * This effectively "drops" all unconsumed events, leaving
         * EV_SYN/SYN_DROPPED plus the newest event in the queue.
         */</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">input_event_sec</span> <span class="o">=</span>
                        <span class="n">event</span><span class="o">-&gt;</span><span class="n">input_event_sec</span><span class="p">;</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">input_event_usec</span> <span class="o">=</span>
                        <span class="n">event</span><span class="o">-&gt;</span><span class="n">input_event_usec</span><span class="p">;</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">EV_SYN</span><span class="p">;</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">code</span> <span class="o">=</span> <span class="n">SYN_DROPPED</span><span class="p">;</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">client</span><span class="o">-&gt;</span><span class="n">packet_head</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_SYN</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">SYN_REPORT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">client</span><span class="o">-&gt;</span><span class="n">packet_head</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
        <span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">input_event</code> ç»“æ„ä½“ï¼š</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">input_event</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h3 id="37-ç”¨æˆ·ç©ºé—´è¯»å–äº‹ä»¶"><span id="3.7">3.7 ç”¨æˆ·ç©ºé—´è¯»å–äº‹ä»¶</span></h3>
<p>æˆ‘ä»¬ä»ä¸Šé¢åˆ†æ,çœ‹åˆ°æ•°æ®å·²ç»æ”¾åˆ°äº†client-&gt;buffer[], é‚£è¯»å–ä¹Ÿè‚¯å®šä¹Ÿæ˜¯ä»è¿™é‡Œè¯»ã€‚å®é™…ä¸Šï¼Œåœ¨æ–‡ä»¶evdev.c ä¸­<code class="language-plaintext highlighter-rouge">Evdev_read()</code>å‡½æ•°å°†è¿™ä¸ª<code class="language-plaintext highlighter-rouge">input_event</code>æ•°ç»„å¤åˆ¶ç»™ç”¨æˆ·ç©ºé—´ã€‚</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">evdev_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
              <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">evdev_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">evdev</span> <span class="o">*</span><span class="n">evdev</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">evdev</span><span class="p">;</span>
<span class="p">......</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<span class="p">......</span><span class="c1">//å¾ªç¯è¯»å–ä¸‹ä¸€ä¸ªäº‹ä»¶, å¹¶é€šè¿‡input_event_to_user() --&gt; copy_to_user()ç»™ç”¨æˆ·ç©ºé—´, è¿™æ ·ä¸Šé¢å°±è¯»åˆ°æ•°æ®äº†.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">read</span> <span class="o">+</span> <span class="n">input_event_size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">&amp;&amp;</span>
               <span class="n">evdev_fetch_next_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">input_event_to_user</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">read</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">))</span>
<span class="p">......</span>
    <span class="k">return</span> <span class="n">read</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">input_event_to_user()</code>å‡½æ•°</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">input_event_to_user</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_event</span> <span class="o">*</span> <span class="n">event</span><span class="p">){</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_event</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>äº‹ä»¶è¯»å–å‡½æ•°è°ƒç”¨æµç¨‹</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">readæ—¶å€™ evdev_read--&gt; ä»client-&gt;buffer[]å¾ªç¯è·å–äº‹ä»¶ evdev_fetch_next_event() --&gt; input_event_to_user() --&gt; copy_to_user()</code></pre></figure>

<h2 id="4-æ€»ç»“"><span id="4">4. æ€»ç»“</span></h2>

<p>æœ€åæ€»ç»“ä¸€ä¸‹æ•´ä¸ªæ•°æ®çš„èµ°å‘å’Œä¼ é€çš„æµç¨‹ã€‚</p>

<p><img src="/assets/image/touch-touchevent-04.png" alt="touchevent framework" /></p>

<ol>
  <li>æŒ‰ç…§linuxè®¾å¤‡æ¶æ„,é©±åŠ¨æ¨¡å‹å®ç°touchscreen driverã€‚</li>
  <li>æ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¸­å°†è§¦æ‘¸å±æ³¨å†Œåˆ°äº†è¾“å…¥å­ç³»ç»Ÿä¸­ï¼Œäºæ­¤åŒæ—¶ï¼Œæ³¨å†Œå‡½æ•°åœ¨äº‹ä»¶å¤„ç†å±‚é“¾è¡¨ä¸­å¯»æ‰¾äº‹ä»¶å¤„ç†å™¨ï¼Œè¿™é‡Œæ‰¾åˆ°çš„æ˜¯evdevï¼Œå¹¶ä¸”å°†é©±åŠ¨ä¸äº‹ä»¶å¤„ç†å™¨æŒ‚è½½ã€‚å¹¶ä¸”åœ¨<code class="language-plaintext highlighter-rouge">/dev/input</code>ä¸­ç”Ÿæˆè®¾å¤‡æ–‡ä»¶event0ï¼Œä»¥åæˆ‘ä»¬è®¿é—®è¿™ä¸ªæ–‡ä»¶å°±ä¼šè®¿é—®åˆ°è®¾å¤‡æ•°æ®ã€‚</li>
</ol>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">å½“å„ä¸ªhandler initæ—¶ --&gt; input_register_handler() --&gt; input_attach_handler() --&gt;  handler-&gt;connect()
æˆ–è€…é©±åŠ¨ --&gt; probe() --&gt; input_register_device() --&gt; input_attach_handler --&gt;  handler-&gt;connect()

                                             +--&gt; input_register_handle() devå’Œhandlerå…³è”
handler-&gt;connect()--&gt;  eg:evdev.c events() --+
                                             +--&gt;cdev_device_add() æ³¨å†Œå­—ç¬¦è®¾å¤‡</code></pre></figure>

<ol>
  <li>å½“ç‚¹å‡»è§¦å±å, è¿›åˆ°ä¸­æ–­å¤„ç†,ç„¶åè¯»å–æ•°æ®,å†report,å¹¶å­˜åˆ°clientçš„buffer[]é‡Œã€‚</li>
</ol>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">input_report_abs() --&gt; input_event(, EV_ABS, , ) --&gt; input_handle_event() --&gt; input_pass_values() --&gt; input_to_handler() --&gt;
handler-&gt;events()/event() --&gt; eg:evdev.c events() --&gt; evdev_pass_values() --&gt; æ•°æ®å¡«å…… --&gt; __pass_event() --&gt; client-&gt;buffer[]</code></pre></figure>

<ol>
  <li>ä¸Šå±‚ç”¨æˆ·ç©ºè°ƒreadæ—¶, åªè¦æœ‰æ•°æ®,ä¸æ–­ä»client-&gt;buffer[]è¯»å–å¹¶é€šè¿‡<code class="language-plaintext highlighter-rouge">copy_to_user()</code>æ‹·åˆ°ç”¨æˆ·ç©ºé—´, æ‰€ä»¥ä¸Šå±‚å°±æ‹¿åˆ°æ•°æ®äº†ã€‚</li>
</ol>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">readæ—¶å€™...--&gt; evdev_read--&gt; ä»client-&gt;buffer[]å¾ªç¯è·å–äº‹ä»¶ evdev_fetch_next_event() --&gt; 
input_event_to_user() --&gt; copy_to_user()</code></pre></figure>
:ET